<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Giỏ hàng của bạn</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

      <link th:href="@{/css/home.css}" rel="stylesheet">

  </head>
  <body>
    <div th:replace="~{common/header :: header}"></div>

    <main class="container my-5">
      <h2 class="mb-4 text-primary">
        <i class="fas fa-shopping-cart me-2"></i>Giỏ hàng của bạn
      </h2>

      <div
        th:if="${items == null or items.isEmpty()}"
        class="text-center py-5 bg-light rounded"
      >
        <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>
        <h4 class="text-muted">Giỏ hàng trống</h4>
        <a href="/toollist" class="btn btn-primary btn-lg">Tiếp tục mua sắm</a>
      </div>

      <div th:if="${items != null and !items.isEmpty()}">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-primary">
            <tr>
              <th style="width:56px;" class="text-center">
                <input class="form-check-input" type="checkbox" id="selectAll" />
              </th>
              <th>Sản phẩm</th>
              <th>License</th>
              <th>Giá</th>
              <th>Số lượng</th>
              <th>Tổng</th>
              <th></th>
            </tr>
            </thead>
            <tbody>
              <tr th:each="item : ${items}"
                  th:attr="data-id=${item.cartItemId},
             data-total=${item.totalPrice},
             data-name=${item.tool.toolName}">
                <td class="text-center">
                  <input
                          class="form-check-input item-check"
                          type="checkbox"
                          th:value="${item.cartItemId}"
                          checked
                          onchange="recalcSelectedTotal()"
                  />
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <img
                      th:src="@{${item.tool.image != null ? '/uploads/images/' + item.tool.image : '/img/placeholder-tool.jpg'}}"
                      width="70"
                      class="rounded me-3"
                      alt="tool"
                    />
                    <div>
                      <strong th:text="${item.tool.toolName}">Tool</strong>
                    </div>
                  </div>
                </td>
                <td th:text="${item.license.name}">License</td>
                <td
                  th:text="${#numbers.formatInteger(item.unitPrice, 0, 'COMMA')} + ' VND'"
                ></td>
                <td>
                  <input
                    type="number"
                    class="form-control w-75"
                    min="1"
                    th:value="${item.quantity}"
                    th:data-id="${item.cartItemId}"
                    onchange="updateQty(this)"
                  />
                </td>
                <td
                  th:text="${#numbers.formatInteger(item.totalPrice, 0, 'COMMA')} + ' VND'"
                ></td>
                <td>
                  <button
                    class="btn btn-sm btn-outline-danger"
                    th:onclick="'removeItem(' + ${item.cartItemId} + ')'"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mt-4 bg-light p-4 rounded">
          <div>
            <div class="text-muted">Đã chọn: <span id="selectedCount" class="fw-bold">0</span> sản phẩm</div>
            <h4 class="mb-0">
              Tổng thanh toán:
              <span id="selectedTotal" class="text-danger fw-bold fs-3">0 VND</span>
            </h4>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-outline-danger btn-lg" type="button" onclick="removeSelected()">
              <i class="bi bi-trash me-2"></i>Xoá đã chọn
            </button>

            <button class="btn btn-success btn-lg px-5" type="button" onclick="goCheckoutSelected()">
              <i class="fas fa-credit-card me-2"></i>Thanh toán
            </button>
          </div>
        </div>

      </div>
    </main>

    <div th:replace="~{common/footer :: footer}"></div>

    <script th:inline="javascript">
      function formatVND(n) {
        return new Intl.NumberFormat("vi-VN").format(n) + " VND";
      }

      function getSelectedIds() {
        return Array.from(document.querySelectorAll(".item-check:checked"))
                .map(cb => cb.value)
                .filter(Boolean);
      }

      function recalcSelectedTotal() {
        const allChecks = Array.from(document.querySelectorAll(".item-check"));
        const checked = allChecks.filter(cb => cb.checked);

        let total = 0;
        checked.forEach(cb => {
          const row = cb.closest("tr");
          const rowTotal = parseFloat(row?.dataset?.total || "0");
          total += isNaN(rowTotal) ? 0 : rowTotal;
        });

        const countEl = document.getElementById("selectedCount");
        const totalEl = document.getElementById("selectedTotal");
        if (countEl) countEl.textContent = checked.length;
        if (totalEl) totalEl.textContent = formatVND(total);

        const selectAll = document.getElementById("selectAll");
        if (selectAll) {
          selectAll.checked = allChecks.length > 0 && checked.length === allChecks.length;
          selectAll.indeterminate = checked.length > 0 && checked.length < allChecks.length;
        }
      }

      function bindSelectAll() {
        const selectAll = document.getElementById("selectAll");
        if (!selectAll) return;

        selectAll.addEventListener("change", function () {
          const checked = this.checked;
          document.querySelectorAll(".item-check").forEach(cb => cb.checked = checked);
          recalcSelectedTotal();
        });
      }

      async function updateQty(input) {
        const id = input.dataset.id;
        let qty = parseInt(input.value);

        if (isNaN(qty) || qty < 1) {
          input.value = 1;
          qty = 1;
        }

        try {
          const res = await fetch("/cart/update", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ cartItemId: id, quantity: qty }),
          });

          if (res.ok) {
            await res.json().catch(() => null);
            location.reload();
          } else {
            const errorData = await res.json().catch(() => ({}));
            alert("Cập nhật thất bại: " + (errorData.message || res.status));
          }
        } catch (e) {
          alert("Lỗi kết nối: " + e.message);
        }
      }

      async function removeItem(id) {
        if (!confirm("Xóa sản phẩm này khỏi giỏ hàng?")) return;

        try {
          const res = await fetch("/cart/remove", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ cartItemId: id }),
          });

          if (res.ok) {
            await res.json().catch(() => null);
            location.reload();
          } else {
            const errorData = await res.json().catch(() => ({}));
            alert("Xóa thất bại: " + (errorData.message || res.status));
          }
        } catch (e) {
          alert("Xóa thất bại: " + e.message);
        }
      }

      async function removeSelected() {
        const ids = getSelectedIds();
        if (ids.length === 0) return alert("Bạn chưa chọn sản phẩm nào.");

        if (!confirm(`Xóa ${ids.length} sản phẩm đã chọn khỏi giỏ hàng?`)) return;

        for (const id of ids) {
          try {
            await fetch("/cart/remove", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({ cartItemId: id }),
            });
          } catch (e) {
            console.error("Remove selected error:", e);
          }
        }
        location.reload();
      }

      function goCheckoutSelected() {
        const ids = getSelectedIds();

        if (ids.length === 0) {
          window.location.href = "/checkout";
          return;
        }

        const qs = encodeURIComponent(ids.join(","));
        window.location.href = "/checkout?selected=" + qs;
      }


      document.addEventListener("DOMContentLoaded", () => {
        bindSelectAll();

        recalcSelectedTotal();

        document.querySelectorAll(".item-check").forEach(cb => {
          cb.addEventListener("change", recalcSelectedTotal);
        });

        if (typeof window.updateCartCount === "function") {
          window.updateCartCount();
        }
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  </body>
</html>
