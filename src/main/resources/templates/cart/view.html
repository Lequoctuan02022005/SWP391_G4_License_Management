<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your cart</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link th:href="@{/css/home.css}" rel="stylesheet" />
</head>

<body>
<div th:replace="~{common/header :: header}"></div>

<main class="container my-5">
  <h2 class="mb-4 text-primary">
    <i class="fas fa-shopping-cart me-2"></i>Your cart
  </h2>

  <!-- EMPTY -->
  <div th:if="${items == null or items.isEmpty()}" class="text-center py-5 bg-light rounded">
    <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>
    <h4 class="text-muted">Your cart is empty</h4>
    <a th:href="@{/toollist}" class="btn btn-primary btn-lg">Tiếp tục mua sắm</a>
  </div>

  <!-- HAS ITEMS -->
  <div th:if="${items != null and !items.isEmpty()}">

    <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2">
      <div class="text-muted small">Tick the products you want to pay for</div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-primary">
        <tr>
          <th style="width:56px;" class="text-center">
            <input class="form-check-input" type="checkbox" id="selectAll" />
          </th>
          <th>Product</th>
          <th>License</th>
          <th class="text-nowrap">Price</th>
          <th style="width:130px;">Quantity</th>
          <th class="text-nowrap">Total</th>
          <th style="width:90px;"></th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="item : ${items}"
            th:attr="data-id=${item.cartItemId},
                         data-total=${item.totalPrice}">
          <td class="text-center">
            <input
                    class="form-check-input item-check"
                    type="checkbox"
                    th:value="${item.cartItemId}"
                    checked
            />
          </td>

          <td>
            <div class="d-flex align-items-center">
              <img
                      th:src="${item.tool.image != null}
                              ? ${item.tool.image}
                              : ${/img/placeholder-tool.jpg}"
                      width="70"
                      height="70"
                      class="rounded me-3"
                      style="object-fit:cover;"
                      alt="tool"
              />
              <div>
                <div class="fw-semibold" th:text="${item.tool.toolName}">Tool</div>
              </div>
            </div>
          </td>

          <td th:text="${item.license.name}">License</td>

          <td class="text-nowrap"
              th:text="${#numbers.formatInteger(item.unitPrice, 0, 'COMMA')} + ' VND'">
          </td>

          <td>
            <input
                    type="number"
                    class="form-control"
                    min="1"
                    th:value="${item.quantity}"
                    th:data-id="${item.cartItemId}"
                    onchange="updateQty(this)"
            />
          </td>

          <td class="text-nowrap fw-semibold"
              th:text="${#numbers.formatInteger(item.totalPrice, 0, 'COMMA')} + ' VND'">
          </td>

          <td class="text-end">
            <button class="btn btn-outline-danger btn-sm"
                    type="button"
                    th:onclick="|removeItem('${item.cartItemId}')|">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>

        </tbody>
      </table>
    </div>

    <!-- SUMMARY -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mt-4 bg-light p-4 rounded">
      <div>
        <div class="text-muted">
          Selected: <span id="selectedCount" class="fw-bold">0</span> products
        </div>
        <div class="fs-5">
          Total payment:
          <span id="selectedTotal" class="text-danger fw-bold fs-3">0 VND</span>
        </div>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-outline-danger btn-lg" type="button" onclick="removeSelected()">
          <i class="bi bi-trash me-2"></i>Delete selected
        </button>

        <button class="btn btn-success btn-lg px-5" type="button" onclick="goCheckoutSelected()">
          <i class="fas fa-credit-card me-2"></i>Pay
        </button>
      </div>
    </div>

  </div>
</main>

<script>
  function formatVND(n) {
    return new Intl.NumberFormat("vi-VN").format(n) + " VND";
  }

  function getSelectedIds() {
    return Array.from(document.querySelectorAll(".item-check:checked"))
            .map(cb => cb.value)
            .filter(Boolean);
  }

  function recalcSelectedTotal() {
    const allChecks = Array.from(document.querySelectorAll(".item-check"));
    const checked = allChecks.filter(cb => cb.checked);

    let total = 0;
    checked.forEach(cb => {
      const row = cb.closest("tr");
      const rowTotal = parseFloat(row?.dataset?.total || "0");
      total += isNaN(rowTotal) ? 0 : rowTotal;
    });

    const countEl = document.getElementById("selectedCount");
    const totalEl = document.getElementById("selectedTotal");
    if (countEl) countEl.textContent = checked.length;
    if (totalEl) totalEl.textContent = formatVND(total);

    const selectAll = document.getElementById("selectAll");
    if (selectAll) {
      selectAll.checked = allChecks.length > 0 && checked.length === allChecks.length;
      selectAll.indeterminate = checked.length > 0 && checked.length < allChecks.length;
    }
  }

  function bindSelectAll() {
    const selectAll = document.getElementById("selectAll");
    if (!selectAll) return;

    selectAll.addEventListener("change", function () {
      const checked = this.checked;
      document.querySelectorAll(".item-check").forEach(cb => (cb.checked = checked));
      recalcSelectedTotal();
    });
  }

  async function updateQty(input) {
      const id = input.dataset.id;
      let newQty = parseInt(input.value, 10);

      if (isNaN(newQty) || newQty < 1) {
          input.value = input.defaultValue || 1; // nếu không có defaultValue thì về 1
          return;
      }

      // Lưu lại giá trị cũ trước khi gửi (rất quan trọng!)
      const oldQty = input.defaultValue ? parseInt(input.defaultValue) : newQty;

      try {
          const res = await fetch("/cart/update", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({
                  cartItemId: id,
                  quantity: newQty
              }),
          });

          const data = await res.json();

          if (res.ok && data.success) {
              // Thành công → cập nhật defaultValue và reload để đồng bộ tổng tiền
              input.defaultValue = newQty;
              location.reload(); // vẫn reload để cập nhật tổng tiền, count, v.v.
          } else {
              // Lỗi từ backend (ví dụ: vượt tồn kho)
              const message = data.message || "Update quantity failed.";
              alert(message);

              // Khôi phục lại giá trị cũ
              input.value = oldQty;

              // Focus lại để người dùng sửa ngay
              input.focus();
              input.select(); // bôi đen số để dễ sửa
          }
      } catch (e) {
          // Lỗi mạng hoặc parse JSON
          alert("Connection error, please try again.");
          input.value = oldQty; // vẫn khôi phục
          console.error("Update quantity error:", e);
      }
  }

  async function removeItem(id) {
    if (!confirm("Delete this product from your cart?")) return;

    try {
      const res = await fetch("/cart/remove", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ cartItemId: id }),
      });

      if (res.ok) {
        await res.json().catch(() => null);
        location.reload();
      } else {
        const errorData = await res.json().catch(() => ({}));
        alert("Delete failed: " + (errorData.message || res.status));
      }
    } catch (e) {
      alert("Delete failed: " + e.message);
    }
  }

  async function removeSelected() {
    const ids = getSelectedIds();
    if (ids.length === 0) return alert("You haven't selected any products.");

    if (!confirm(`Delete ${ids.length} selected products from your cart?`)) return;

    for (const id of ids) {
      try {
        await fetch("/cart/remove", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ cartItemId: id }),
        });
      } catch (e) {
        console.error("Remove selected error:", e);
      }
    }
    location.reload();
  }

  function goCheckoutSelected() {
    const ids = getSelectedIds();

    if (ids.length === 0) {
      alert("Please select at least 1 product to pay.");
      return;
    }

    // If the checkout controller is reading a different param (e.g., items=...), change "selected" to "items" is done.
    window.location.href = "/checkout?selected=" + encodeURIComponent(ids.join(","));
  }

  document.addEventListener("DOMContentLoaded", () => {
    bindSelectAll();
    recalcSelectedTotal();

    document.querySelectorAll(".item-check").forEach(cb => {
      cb.addEventListener("change", recalcSelectedTotal);
    });

    if (typeof window.updateCartCount === "function") {
      window.updateCartCount();
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
