<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tool Market - Home</title>

    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CSS riêng -->
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
<div th:replace="common/header "></div>
<!-- Alerts -->
<div class="container mt-3">
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
</div>

<!-- Hero sáng màu -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center g-4">
            <div class="col-lg-6">
                <p class="hero-badge">Digital Tool Marketplace</p>
                <h1 class="hero-title">
                    Explore the <span class="text-gradient">Online Tool Library</span>
                    with Premium Quality
                </h1>
                <p class="hero-desc">
                    Buy and sell learning, working, and business tools safely,
                    transparently, and conveniently. Filter by service, price,
                    and rating with just a few clicks.
                </p>

                <div class="hero-actions">
                    <a href="#products" class="btn btn-primary btn-lg shadow-sm">
                        <i class="bi bi-bag-check"></i> View Products
                    </a>
                    <a href="#category" class="btn btn-outline-primary btn-lg ms-2">
                        <i class="bi bi-grid"></i> View Services
                    </a>
                </div>

                <div class="hero-stats mt-4">
                    <div class="stat-item">
                        <h3>+1,000</h3>
                        <p>Tools Available</p>
                    </div>
                    <div class="stat-item">
                        <h3>4.9⭐</h3>
                        <p>Average Rating</p>
                    </div>
                    <div class="stat-item">
                        <h3>24/7</h3>
                        <p>Customer Support</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div id="heroCarousel" class="carousel slide hero-carousel" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <!-- Slide 1 -->
                        <div class="carousel-item active">
                            <div class="hero-card">
                                <h2>Today's Deals</h2>
                                <p>Discounts on learning and working tools from trusted sellers.</p>
                                <ul>
                                    <li><i class="bi bi-check-circle-fill"></i> Clear licensed tools</li>
                                    <li><i class="bi bi-check-circle-fill"></i> Flexible pricing options</li>
                                    <li><i class="bi bi-check-circle-fill"></i> Fast & secure payment</li>
                                </ul>
                            </div>
                        </div>
                        <!-- Slide 2 -->
                        <div class="carousel-item">
                            <div class="hero-card">
                                <h2>Tools for Every Need</h2>
                                <p>From students to shop owners, marketers, and freelancers.</p>
                                <ul>
                                    <li><i class="bi bi-stars"></i> AI, design, and marketing tools</li>
                                    <li><i class="bi bi-stars"></i> Learning & research tools</li>
                                    <li><i class="bi bi-stars"></i> Productivity & management tools</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="carousel-indicators hero-indicators">
                        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active"></button>
                        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<!-- Category / Dịch vụ -->
<section class="services-section" id="category">
    <div class="container">
        <div class="section-header">
            <div>
                <h2 class="section-title">Service Categories</h2>
                <p class="section-subtitle">
                    Choose the appropriate service category to quickly find the tools that match your needs.
                </p>
            </div>
        </div>

        <div class="position-relative">
            <button class="service-nav-btn prev" id="prevBtn" style="display:none;">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="service-nav-btn next" id="nextBtn">
                <i class="fas fa-chevron-right"></i>
            </button>

            <div class="row g-4" id="categoryContainer">
                <th:block th:each="category, iterStat : ${categories}">
                    <div class="col-md-4 category-item" th:data-index="${iterStat.index}" style="display:none;">
                        <div class="service-card text-center p-4 shadow-sm rounded bg-white">
                            <div class="service-icon fs-1 mb-3">
                                <i th:class="${category.icon}"></i>
                            </div>
                            <h3 th:text="${category.categoryName}" class="fw-bold mb-2"></h3>
                            <p th:text="${category.description}" class="text-muted small"></p>
                        </div>
                    </div>
                </th:block>
            </div>
        </div>
    </div>
</section>

<!-- Sản phẩm -->
<!-- Products -->
<section class="products-section" id="products">
    <div class="container">
        <div class="section-header">
            <div>
                <h2 class="section-title">Product List</h2>
                <p class="section-subtitle">
                    Filter by keyword, service, price, posted date, and rating to find the right tool.
                </p>
            </div>
        </div>

        <!-- Product Slider -->
        <div id="product-list">
            <div th:fragment="toolList">

                <th:block th:if="${tools == null or #lists.isEmpty(tools)}">
                    <div class="col-12 text-center py-5 text-muted">
                        <i class="bi bi-search fs-2 d-block mb-2"></i>
                        <h5>No matching products found</h5>
                        <p class="small">Try changing the keyword or removing some filters.</p>
                    </div>
                </th:block>

                <div class="product-slider" th:if="${tools != null and !#lists.isEmpty(tools)}">
                    <div class="product-track">

                        <!-- LIST 1 -->
                        <div class="slider-item" th:each="tool : ${tools}">
                            <a th:href="@{'/tools/detail/' + ${tool.toolId}}" class="product-card">
                                <div class="product-image">
                                    <img th:src="${tool.image != null ? tool.image : '/placeholder.svg?height=250&width=350'}"
                                         alt="Product">
                                </div>

                                <div class="product-info">
                                    <h3 class="product-name fs-6 fw-bold mb-1">
                                        <span th:text="${tool.toolName}"></span>
                                        <span th:if="${tool.availableQuantity == 0}"
                                              class="badge bg-danger ms-2">Out of stock</span>
                                    </h3>

                                    <p class="seller-name mb-1">
                                        <i class="bi bi-person-circle"></i>
                                        <span th:text="${tool.seller.fullName}"></span>
                                    </p>

                                    <div class="product-rating mb-2">
                                        <div class="stars">
                                            <span th:each="i : ${#numbers.sequence(1,5)}">
                                                <i th:classappend="${i <= tool.averageRating} ? 'fas fa-star text-warning' :
                                                (${i - tool.averageRating < 1} ? 'fas fa-star-half-alt text-warning' : 'far fa-star text-warning')"></i>
                                            </span>
                                        </div>
                                        <span class="review-count" th:text="${tool.totalReviews + ' reviews'}"></span>
                                    </div>

                                    <p class="product-price fw-bold mb-0">
                                        <i class="bi bi-cash-stack"></i>
                                        <span th:if="${tool.minPrice != null && tool.maxPrice != null}">
                                            <span th:text="${tool.minPrice.equals(tool.maxPrice) ?
                                            #numbers.formatDecimal(tool.minPrice, 0, 'COMMA', 0, 'POINT') :
                                            #numbers.formatDecimal(tool.minPrice, 0, 'COMMA', 0, 'POINT') + ' – ' +
                                            #numbers.formatDecimal(tool.maxPrice, 0, 'COMMA', 0, 'POINT')}"></span>
                                            VND
                                        </span>
                                    </p>
                                </div>
                            </a>
                        </div>

                        <!-- LIST 2 (CLONE FOR SMOOTH LOOP) -->
                        <div class="slider-item" th:each="tool : ${tools}">
                            <a th:href="@{'/tools/detail/' + ${tool.toolId}}" class="product-card">
                                <div class="product-image">
                                    <img th:src="${tool.image != null ? tool.image : '/placeholder.svg?height=250&width=350'}"
                                         alt="Product">
                                </div>

                                <div class="product-info">
                                    <h3 class="product-name fs-6 fw-bold mb-1">
                                        <span th:text="${tool.toolName}"></span>
                                        <span th:if="${tool.availableQuantity == 0}"
                                              class="badge bg-danger ms-2">Out of stock</span>
                                    </h3>

                                    <p class="seller-name mb-1">
                                        <i class="bi bi-person-circle"></i>
                                        <span th:text="${tool.seller.fullName}"></span>
                                    </p>

                                    <div class="product-rating mb-2">
                                        <div class="stars">
                                            <span th:each="i : ${#numbers.sequence(1,5)}">
                                                <i th:classappend="${i <= tool.averageRating} ? 'fas fa-star text-warning' :
                                                (${i - tool.averageRating < 1} ? 'fas fa-star-half-alt text-warning' : 'far fa-star text-warning')"></i>
                                            </span>
                                        </div>
                                        <span class="review-count" th:text="${tool.totalReviews + ' reviews'}"></span>
                                    </div>

                                    <p class="product-price fw-bold mb-0">
                                        <i class="bi bi-cash-stack"></i>
                                        <span th:if="${tool.minPrice != null && tool.maxPrice != null}">
                                            <span th:text="${tool.minPrice.equals(tool.maxPrice) ?
                                            #numbers.formatDecimal(tool.minPrice, 0, 'COMMA', 0, 'POINT') :
                                            #numbers.formatDecimal(tool.minPrice, 0, 'COMMA', 0, 'POINT') + ' – ' +
                                            #numbers.formatDecimal(tool.maxPrice, 0, 'COMMA', 0, 'POINT')}"></span>
                                            VND
                                        </span>
                                    </p>
                                </div>
                            </a>
                        </div>

                    </div>
                </div>

            </div>
        </div>

    </div>
</section>

        <div th:replace="common/footer :: footer"></div>
<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    const TOOLS_URL      = /*[[@{/home/tools}]]*/ "/home/tools";
    const FAV_COUNT_URL  = /*[[@{/favorite/count}]]*/ "/favorite/count";
    const FAV_TOGGLE_URL = /*[[@{/favorite/toggle}]]*/ "/favorite/toggle";
    const LOGIN_URL      = /*[[@{/login}]]*/ "/login";

    window.loadFavoriteCount = async function () {
        const badge = document.getElementById("favoriteCountBadge");
        if (!badge) return;

        try {
            const res = await fetch(FAV_COUNT_URL, { credentials: "include" });
            if (res.redirected) { window.location.href = res.url; return; }
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const count = await res.json();
            badge.textContent = count;
            badge.style.display = count > 0 ? "inline-block" : "none";
        } catch (e) {
            badge.textContent = "0";
            badge.style.display = "none";
        }
    };

    document.addEventListener("DOMContentLoaded", function () {
        const filterForm = document.getElementById("filterForm");
        const productListContainer = document.getElementById("product-list");
        const clearFiltersBtn = document.getElementById("clearFilters");

        if (!productListContainer) return;

        function buildQuery(params = {}) {
            const fd = filterForm ? new FormData(filterForm) : new FormData();

            for (const [k, v] of Object.entries(params)) {
                if (v !== undefined && v !== null) fd.set(k, v);
            }

            const kw = (fd.get("keyword") || "").trim();
            if (!kw) fd.delete("keyword"); else fd.set("keyword", kw);

            const cat = (fd.get("categoryId") || "").trim();
            if (!cat) fd.delete("categoryId");

            const date = (fd.get("dateFilter") || "").trim();
            if (!date) fd.delete("dateFilter");

            const price = (fd.get("priceFilter") || "").trim();
            if (!price || price === "all") fd.delete("priceFilter");

            const rating = (fd.get("ratingFilter") || "").trim();
            if (!rating) fd.delete("ratingFilter");

            if (!fd.has("page")) fd.set("page", "0");

            const sizeEl = document.getElementById("pageSizeSelect");
            const size = params.size ?? (sizeEl ? sizeEl.value : "9");
            fd.set("size", String(size));

            return new URLSearchParams(fd).toString();
        }

        async function loadTools(params = {}) {
            try {
                const query = buildQuery(params);
                const res = await fetch(`${TOOLS_URL}?${query}`, {
                    method: "GET",
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                    credentials: "include",
                });

                if (res.redirected) { window.location.href = res.url; return; }
                if (res.status === 401) { window.location.href = LOGIN_URL; return; }

                if (!res.ok) {
                    console.error("Lỗi tải tools:", res.status, await res.text());
                    return;
                }

                const html = await res.text();
                productListContainer.innerHTML = html;

                attachPaginationListeners();
                attachPageSizeListener();
                window.loadFavoriteCount();
            } catch (err) {
                console.error("loadTools() error:", err);
            }
        }

        productListContainer.addEventListener("click", async function (ev) {
            const favEl = ev.target.closest(".favorite-icon");
            if (!favEl) return;

            ev.preventDefault();
            ev.stopPropagation();

            const toolId = favEl.getAttribute("data-tool-id");
            if (!toolId) return;

            try {
                const res = await fetch(`${FAV_TOGGLE_URL}?toolId=${encodeURIComponent(toolId)}`, {
                    method: "POST",
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                    credentials: "include",
                });

                if (res.redirected) { window.location.href = res.url; return; }
                if (res.status === 401) { window.location.href = LOGIN_URL; return; }

                const result = (await res.text()).trim();
                const icon = favEl.querySelector("i");
                if (!icon) return;

                const badge = document.getElementById("favoriteCountBadge");
                let currentCount = badge ? parseInt(badge.textContent || "0", 10) : 0;

                if (result === "added") {
                    icon.className = "fas fa-heart text-danger";
                    currentCount += 1;
                } else {
                    icon.className = "far fa-heart";
                    currentCount = Math.max(0, currentCount - 1);
                }

                if (badge) {
                    badge.textContent = currentCount;
                    badge.style.display = currentCount > 0 ? "inline-block" : "none";
                }

                document.dispatchEvent(new Event("favorite-changed"));
            } catch (err) {
                console.error("toggle favorite error:", err);
            }
        });

        function attachPaginationListeners() {
            productListContainer.querySelectorAll(".page-link").forEach(link => {
                if (link.dataset.bound === "1") return;
                link.dataset.bound = "1";

                link.addEventListener("click", function (e) {
                    e.preventDefault();

                    const item = this.closest(".page-item");
                    if (item && item.classList.contains("disabled")) return;

                    const page = this.getAttribute("data-page");
                    if (page == null) return;

                    const p = parseInt(page, 10);
                    if (Number.isNaN(p) || p < 0) return;

                    const sizeEl = document.getElementById("pageSizeSelect");
                    const size = sizeEl ? sizeEl.value : "9";
                    loadTools({ page: p, size });
                });
            });
        }

        function attachPageSizeListener() {
            const sizeSelect = document.getElementById("pageSizeSelect");
            if (!sizeSelect) return;

            if (sizeSelect.dataset.bound === "1") return;
            sizeSelect.dataset.bound = "1";

            sizeSelect.addEventListener("change", function () {
                loadTools({ page: 0, size: this.value || "9" });
            });
        }

        if (filterForm) {
            filterForm.addEventListener("submit", function (e) {
                e.preventDefault();
                loadTools({ page: 0 });
            });

            filterForm.addEventListener("change", function () {
                loadTools({ page: 0 });
            });
        }

        if (clearFiltersBtn && filterForm) {
            clearFiltersBtn.addEventListener("click", function () {
                filterForm.reset();
                const sizeEl = document.getElementById("pageSizeSelect");
                if (sizeEl) sizeEl.value = "9";
                loadTools({ page: 0, size: "9" });
            });
        }

        attachPaginationListeners();
        attachPageSizeListener();
        window.loadFavoriteCount();
    });

    // Category carousel
    document.addEventListener("DOMContentLoaded", function () {
        const items = document.querySelectorAll(".category-item");
        const nextBtn = document.getElementById("nextBtn");
        const prevBtn = document.getElementById("prevBtn");
        if (!items.length || !nextBtn || !prevBtn) return;

        const itemsPerPage = 3;
        let currentIndex = 0;

        function showItems() {
            items.forEach(i => i.style.display = "none");
            for (let i = currentIndex; i < currentIndex + itemsPerPage && i < items.length; i++) {
                items[i].style.display = "block";
            }
            prevBtn.style.display = currentIndex === 0 ? "none" : "block";
            nextBtn.style.display = currentIndex + itemsPerPage >= items.length ? "none" : "block";
        }

        nextBtn.addEventListener("click", function () {
            if (currentIndex + itemsPerPage < items.length) {
                currentIndex += itemsPerPage;
                showItems();
            }
        });

        prevBtn.addEventListener("click", function () {
            if (currentIndex - itemsPerPage >= 0) {
                currentIndex -= itemsPerPage;
                showItems();
            }
        });

        showItems();
    });

    document.addEventListener("favorite-changed", function () {
        window.loadFavoriteCount();
    });
</script>

</body>
</html>
