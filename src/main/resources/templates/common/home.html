<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Home</title>

    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link th:href="@{/css/home.css}" rel="stylesheet">
</head>
<body>

<!-- Header -->
<div th:replace="common/header :: header"></div>

<!-- Success/Error Alerts -->
<div class="container mt-3">
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
</div>

<!-- Banner -->
<section class="hero-section">
    <div class="container">
        <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <h1>Banner qu·∫£ng c√°o</h1>
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit...</p>
                    <div class="mt-4">
                        <a href="#products" class="hero-btn-primary">SHOP SALES</a>
                        <a href="#products" class="hero-btn-secondary">ALL PRODUCTS</a>
                    </div>
                </div>

                <div class="carousel-item">
                    <h1>Banner qu·∫£ng c√°o 2</h1>
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit...</p>
                    <div class="mt-4">
                        <a href="#products" class="hero-btn-primary">SHOP SALES</a>
                        <a href="#products" class="hero-btn-secondary">ALL PRODUCTS</a>
                    </div>
                </div>
            </div>

            <div class="carousel-indicators">
                <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active"></button>
                <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1"></button>
            </div>
        </div>
    </div>
</section>

<!-- D·ªãch v·ª• -->
<section class="services-section" id="category">
    <div class="container">
        <h2 class="section-title">DANH S√ÅCH D·ªäCH V·ª§</h2>

        <div class="position-relative">
            <button class="service-nav-btn prev" id="prevBtn" style="display:none;">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="service-nav-btn next" id="nextBtn">
                <i class="fas fa-chevron-right"></i>
            </button>

            <div class="row g-4" id="categoryContainer">
                <th:block th:each="category, iterStat : ${categories}">
                    <div class="col-md-4 category-item" th:data-index="${iterStat.index}" style="display:none;">
                        <div class="service-card text-center p-4 shadow-sm rounded bg-white">
                            <div class="service-icon fs-1 mb-3">
                                <i th:class="${category.icon}"></i>
                            </div>
                            <h3 th:text="${category.categoryName}" class="fw-bold mb-2"></h3>
                            <p th:text="${category.description}" class="text-muted"></p>
                        </div>
                    </div>
                </th:block>
            </div>
        </div>
    </div>
</section>

<!-- Danh s√°ch s·∫£n ph·∫©m -->
<section class="products-section" id="products">
    <div class="container">
        <h2 class="section-title">DANH S√ÅCH S·∫¢N PH·∫®M</h2>

        <!-- Filter -->
        <form class="search-filter-bar" id="filterForm">
            <div class="row g-3 align-items-end">
                <div class="col-md-5 search-box">
                    <input type="text" class="form-control" name="keyword"
                           placeholder="T√¨m ki·∫øm tool ho·∫∑c seller"
                           th:value="${keyword}">
                </div>

                <div class="col-md-2">
                    <select class="form-select" name="categoryId">
                        <option value="">T·∫•t c·∫£ d·ªãch v·ª•</option>
                        <option th:each="cate : ${categories}"
                                th:value="${cate.categoryId}"
                                th:text="${cate.categoryName}"
                                th:selected="${cate.categoryId == selectedCategory}">
                        </option>
                    </select>
                </div>

                <div class="col-md-2">
                    <select class="form-select" name="dateFilter">
                        <option value="">Ng√†y ƒëƒÉng</option>
                        <option value="1" th:selected="${dateFilter=='1'}">M·ªõi nh·∫•t</option>
                        <option value="2" th:selected="${dateFilter=='2'}">30 ng√†y qua</option>
                        <option value="3" th:selected="${dateFilter=='3'}">3 th√°ng qua</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <select class="form-select" name="priceFilter">
                        <option value="all" th:selected="${priceFilter=='all' or priceFilter == null}">M·ªçi gi√°</option>
                        <option value="under100k" th:selected="${priceFilter=='under100k'}">D∆∞·ªõi 100.000</option>
                        <option value="100k-500k" th:selected="${priceFilter=='100k-500k'}">100.000 - 500.000</option>
                        <option value="500k-1m" th:selected="${priceFilter=='500k-1m'}">500.000 - 1.000.000</option>
                        <option value="above1m" th:selected="${priceFilter=='above1m'}">Tr√™n 1.000.000</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <select class="form-select" name="ratingFilter">
                        <option value="">S·ªë sao</option>
                        <option value="1" th:selected="${ratingFilter==1}">1‚≠ê tr·ªü l√™n</option>
                        <option value="2" th:selected="${ratingFilter==2}">2‚≠ê tr·ªü l√™n</option>
                        <option value="3" th:selected="${ratingFilter==3}">3‚≠ê tr·ªü l√™n</option>
                        <option value="4" th:selected="${ratingFilter==4}">4‚≠ê tr·ªü l√™n</option>
                        <option value="5" th:selected="${ratingFilter==5}">5‚≠ê</option>
                    </select>
                </div>

                <div class="col-md-auto">
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="bi bi-search"></i> T√¨m ki·∫øm
                    </button>
                </div>
                <div class="col-md-auto">
                    <button type="button" id="clearFilters" class="btn btn-secondary px-4">
                        <i class="bi bi-x-circle"></i> X√≥a l·ªçc
                    </button>
                </div>
            </div>
        </form>

        <!-- List (server render tr∆∞·ªõc, ajax s·∫Ω replace sau) -->
        <div id="product-list">
            <!-- ‚úÖ fragment ƒë·ªÉ /home/tools tr·∫£ v·ªÅ -->
            <div th:fragment="toolList">

                <th:block th:if="${tools == null or #lists.isEmpty(tools)}">
                    <div class="col-12 text-center py-4 text-muted">
                        <h5>Kh√¥ng c√≥ s·∫£n ph·∫©m ph√π h·ª£p</h5>
                    </div>
                </th:block>

                <div class="row g-4" th:if="${tools != null and !#lists.isEmpty(tools)}">
                    <div class="col-md-4" th:each="tool : ${tools}">
                        <a th:href="@{'/tools/detail/' + ${tool.toolId}}" class="product-card">
                            <div class="product-image">

                                <!-- Favorite (n·∫øu anh mu·ªën b·∫≠t l·∫°i) -->
                                <!--
                                <div class="favorite-icon" th:attr="data-tool-id=${tool.toolId}">
                                    <i th:class="${tool.isFavorite} ? 'fas fa-heart text-danger' : 'far fa-heart'"></i>
                                </div>
                                -->

                                <img th:src="${tool.image != null ? tool.image : '/placeholder.svg?height=250&width=350'}"
                                     alt="Product">
                            </div>

                            <div class="product-info">
                                <h3 class="product-name fs-5 fw-bold">
                                    <span th:text="${tool.toolName}"></span>
                                    <span th:if="${tool.availableQuantity == 0}"
                                          class="text-danger fw-bold ms-2 fs-6">(H·∫øt h√†ng)</span>
                                </h3>

                                <span th:text="'üë§ ' + ${tool.seller.fullName}"></span>

                                <div class="product-rating">
                                    <div class="stars">
                                        <span th:each="i : ${#numbers.sequence(1,5)}">
                                            <i th:classappend="${i <= tool.averageRating} ? 'fas fa-star text-warning' :
                                            (${i - tool.averageRating < 1} ? 'fas fa-star-half-alt text-warning' : 'far fa-star text-warning')"></i>
                                        </span>
                                    </div>
                                    <span class="review-count" th:text="${tool.totalReviews + ' reviews'}"></span>
                                </div>

                                <p class="product-price fw-bold mt-2">
                                    <i class="bi bi-cash-stack"></i>
                                    <span th:if="${tool.minPrice != null && tool.maxPrice != null}">
                                        <span th:text="${tool.minPrice.equals(tool.maxPrice) ?
                                        #numbers.formatDecimal(tool.minPrice, 0, 'COMMA', 0, 'POINT') :
                                        #numbers.formatDecimal(tool.minPrice, 0, 'COMMA', 0, 'POINT') + ' ‚Äì ' +
                                        #numbers.formatDecimal(tool.maxPrice, 0, 'COMMA', 0, 'POINT')}"></span>
                                        VND
                                    </span>
                                </p>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="pagination-wrapper mt-4" th:if="${totalPages != null and totalPages >= 1}">
                    <nav>
                        <ul class="pagination justify-content-center">
                            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                <a href="#" class="page-link" th:data-page="${currentPage - 1}" tabindex="-1">Tr∆∞·ªõc</a>
                            </li>

                            <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                th:classappend="${i == currentPage} ? 'active'">
                                <a href="#" class="page-link" th:data-page="${i}" th:text="${i + 1}"></a>
                            </li>

                            <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                                <a href="#" class="page-link" th:data-page="${currentPage + 1}">Sau</a>
                            </li>
                        </ul>
                    </nav>

                    <div class="ms-3">
                        <label for="pageSizeSelect" class="form-label me-2 mb-0">S·ªë s·∫£n ph·∫©m / trang:</label>
                        <select id="pageSizeSelect" class="form-select d-inline-block w-auto pe-5">
                            <option value="6" th:selected="${pageSize == 6}">6</option>
                            <option value="9" th:selected="${pageSize == 9}">9</option>
                            <option value="12" th:selected="${pageSize == 12}">12</option>
                        </select>
                    </div>
                </div>

            </div>
        </div>

    </div>
</section>

<!-- Footer -->
<div th:replace="common/footer :: footer"></div>

<!-- Bootstrap JS (CH·ªà 1 L·∫¶N) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    const TOOLS_URL      = /*[[@{/home/tools}]]*/ "/home/tools";
    const FAV_COUNT_URL  = /*[[@{/favorite/count}]]*/ "/favorite/count";
    const FAV_TOGGLE_URL = /*[[@{/favorite/toggle}]]*/ "/favorite/toggle";
    const LOGIN_URL      = /*[[@{/login}]]*/ "/login";

    window.loadFavoriteCount = async function () {
        const badge = document.getElementById("favoriteCountBadge");
        if (!badge) return;

        try {
            const res = await fetch(FAV_COUNT_URL, { credentials: "include" });
            if (res.redirected) { window.location.href = res.url; return; }
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const count = await res.json();
            badge.textContent = count;
            badge.style.display = count > 0 ? "inline-block" : "none";
        } catch (e) {
            badge.textContent = "0";
            badge.style.display = "none";
        }
    };

    document.addEventListener("DOMContentLoaded", function () {
        const filterForm = document.getElementById("filterForm");
        const productListContainer = document.getElementById("product-list");
        const clearFiltersBtn = document.getElementById("clearFilters");

        if (!productListContainer) return;

        function buildQuery(params = {}) {
            const fd = filterForm ? new FormData(filterForm) : new FormData();

            // override
            for (const [k, v] of Object.entries(params)) {
                if (v !== undefined && v !== null) fd.set(k, v);
            }

            // ‚úÖ normalize: b·ªè param r·ªóng + b·ªè priceFilter=all
            const kw = (fd.get("keyword") || "").trim();
            if (!kw) fd.delete("keyword"); else fd.set("keyword", kw);

            const cat = (fd.get("categoryId") || "").trim();
            if (!cat) fd.delete("categoryId");

            const date = (fd.get("dateFilter") || "").trim();
            if (!date) fd.delete("dateFilter");

            const price = (fd.get("priceFilter") || "").trim();
            if (!price || price === "all") fd.delete("priceFilter");

            const rating = (fd.get("ratingFilter") || "").trim();
            if (!rating) fd.delete("ratingFilter");

            // page default
            if (!fd.has("page")) fd.set("page", "0");

            // size
            const sizeEl = document.getElementById("pageSizeSelect");
            const size = params.size ?? (sizeEl ? sizeEl.value : "9");
            fd.set("size", String(size));

            return new URLSearchParams(fd).toString();
        }

        async function loadTools(params = {}) {
            try {
                const query = buildQuery(params);
                const res = await fetch(`${TOOLS_URL}?${query}`, {
                    method: "GET",
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                    credentials: "include",
                });

                if (res.redirected) { window.location.href = res.url; return; }
                if (res.status === 401) { window.location.href = LOGIN_URL; return; }

                if (!res.ok) {
                    console.error("L·ªói t·∫£i tools:", res.status, await res.text());
                    return;
                }

                const html = await res.text();
                productListContainer.innerHTML = html;

                attachPaginationListeners();
                attachPageSizeListener();
                window.loadFavoriteCount();
            } catch (err) {
                console.error("loadTools() error:", err);
            }
        }

        // Favorite toggle (event delegation) - n·∫øu anh b·∫≠t l·∫°i favorite-icon
        productListContainer.addEventListener("click", async function (ev) {
            const favEl = ev.target.closest(".favorite-icon");
            if (!favEl) return;

            ev.preventDefault();
            ev.stopPropagation();

            const toolId = favEl.getAttribute("data-tool-id");
            if (!toolId) return;

            try {
                const res = await fetch(`${FAV_TOGGLE_URL}?toolId=${encodeURIComponent(toolId)}`, {
                    method: "POST",
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                    credentials: "include",
                });

                if (res.redirected) { window.location.href = res.url; return; }
                if (res.status === 401) { window.location.href = LOGIN_URL; return; }

                const result = (await res.text()).trim();
                const icon = favEl.querySelector("i");
                if (!icon) return;

                const badge = document.getElementById("favoriteCountBadge");
                let currentCount = badge ? parseInt(badge.textContent || "0", 10) : 0;

                if (result === "added") {
                    icon.className = "fas fa-heart text-danger";
                    currentCount += 1;
                } else {
                    icon.className = "far fa-heart";
                    currentCount = Math.max(0, currentCount - 1);
                }

                if (badge) {
                    badge.textContent = currentCount;
                    badge.style.display = currentCount > 0 ? "inline-block" : "none";
                }

                document.dispatchEvent(new Event("favorite-changed"));
            } catch (err) {
                console.error("toggle favorite error:", err);
            }
        });

        function attachPaginationListeners() {
            productListContainer.querySelectorAll(".page-link").forEach(link => {
                if (link.dataset.bound === "1") return;
                link.dataset.bound = "1";

                link.addEventListener("click", function (e) {
                    e.preventDefault();

                    const item = this.closest(".page-item");
                    if (item && item.classList.contains("disabled")) return;

                    const page = this.getAttribute("data-page");
                    if (page == null) return;

                    const p = parseInt(page, 10);
                    if (Number.isNaN(p) || p < 0) return;

                    const sizeEl = document.getElementById("pageSizeSelect");
                    const size = sizeEl ? sizeEl.value : "9";
                    loadTools({ page: p, size });
                });
            });
        }

        function attachPageSizeListener() {
            const sizeSelect = document.getElementById("pageSizeSelect");
            if (!sizeSelect) return;

            if (sizeSelect.dataset.bound === "1") return;
            sizeSelect.dataset.bound = "1";

            sizeSelect.addEventListener("change", function () {
                loadTools({ page: 0, size: this.value || "9" });
            });
        }

        if (filterForm) {
            filterForm.addEventListener("submit", function (e) {
                e.preventDefault();
                loadTools({ page: 0 });
            });

            filterForm.addEventListener("change", function () {
                loadTools({ page: 0 });
            });
        }

        if (clearFiltersBtn && filterForm) {
            clearFiltersBtn.addEventListener("click", function () {
                filterForm.reset();
                const sizeEl = document.getElementById("pageSizeSelect");
                if (sizeEl) sizeEl.value = "9";
                loadTools({ page: 0, size: "9" });
            });
        }

        // ‚úÖ l·∫ßn ƒë·∫ßu: KH√îNG g·ªçi loadTools() ƒë·ªÉ kh·ªèi ƒë√® list server-render
        attachPaginationListeners();
        attachPageSizeListener();
        window.loadFavoriteCount();
    });

    // Category carousel
    document.addEventListener("DOMContentLoaded", function () {
        const items = document.querySelectorAll(".category-item");
        const nextBtn = document.getElementById("nextBtn");
        const prevBtn = document.getElementById("prevBtn");
        if (!items.length || !nextBtn || !prevBtn) return;

        const itemsPerPage = 3;
        let currentIndex = 0;

        function showItems() {
            items.forEach(i => i.style.display = "none");
            for (let i = currentIndex; i < currentIndex + itemsPerPage && i < items.length; i++) {
                items[i].style.display = "block";
            }
            prevBtn.style.display = currentIndex === 0 ? "none" : "block";
            nextBtn.style.display = currentIndex + itemsPerPage >= items.length ? "none" : "block";
        }

        nextBtn.addEventListener("click", function () {
            if (currentIndex + itemsPerPage < items.length) {
                currentIndex += itemsPerPage;
                showItems();
            }
        });

        prevBtn.addEventListener("click", function () {
            if (currentIndex - itemsPerPage >= 0) {
                currentIndex -= itemsPerPage;
                showItems();
            }
        });

        showItems();
    });

    document.addEventListener("favorite-changed", function () {
        window.loadFavoriteCount();
    });
</script>

</body>
</html>
