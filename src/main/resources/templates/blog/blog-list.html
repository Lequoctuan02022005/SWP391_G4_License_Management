<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Blog - License Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link th:href="@{/css/home.css}" rel="stylesheet">
    <link th:href="@{/css/blog.css}" rel="stylesheet">
</head>
<body>
<!--Header-->
<div th:replace="home/header :: header"></div>

<!-- Blog Header -->
<section class="blog-header">
    <div class="container">
        <h1>Blog & Tin tức</h1>
        <p>Cập nhật các bài viết hữu ích về phần mềm và công nghệ</p>
    </div>
</section>

<!-- Blog Content -->
<section class="blog-section py-5">
    <div class="container">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="blog-sidebar">
                    <!-- Search -->
                    <div class="sidebar-widget">
                        <h5>Tìm kiếm</h5>
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control" placeholder="Tìm bài viết...">
                            <button class="btn btn-primary" onclick="searchBlogs()">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Categories -->
                    <div class="sidebar-widget">
                        <h5>Danh mục</h5>
                        <div id="categoriesList" class="categories-list">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Popular Posts -->
                    <div class="sidebar-widget">
                        <h5>Bài viết xem nhiều</h5>
                        <div id="popularPosts" class="popular-posts">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blog List -->
            <div class="col-lg-9">
                <!-- Filter Bar -->
                <div class="filter-bar mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <p class="mb-0" id="resultsCount">Đang tải...</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary active" data-view="grid" onclick="changeView('grid')">
                                    <i class="bi bi-grid-3x3-gap"></i> Lưới
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" data-view="list" onclick="changeView('list')">
                                    <i class="bi bi-list"></i> Danh sách
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Blog Grid -->
                <div id="blogGrid" class="blog-grid row">
                    <!-- Loading spinner -->
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <nav id="paginationNav" class="mt-4" style="display: none;">
                    <ul class="pagination justify-content-center" id="pagination">
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</section>

<!--Footer-->
<div th:replace="home/footer :: footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/blog.js}"></script>
<script>
    let currentPage = 0;
    let currentCategory = null;
    let currentView = 'grid';
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadCategories();
        loadBlogs();
        loadPopularPosts();
    });
    
    function loadCategories() {
        fetch('/api/public/blog-categories')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('categoriesList');
                if (data.success && data.data && data.data.length > 0) {
                    let html = '<ul class="list-unstyled">';
                    html += '<li><a href="#" onclick="filterByCategory(null); return false;" class="category-link active">Tất cả</a></li>';
                    data.data.forEach(cat => {
                        html += `<li><a href="#" onclick="filterByCategory(${cat.categoryId}); return false;" class="category-link">${cat.name} (${cat.blogCount || 0})</a></li>`;
                    });
                    html += '</ul>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p class="text-muted">Không có danh mục</p>';
                }
            })
            .catch(error => {
                console.error('Error loading categories:', error);
                document.getElementById('categoriesList').innerHTML = '<p class="text-danger">Lỗi tải danh mục</p>';
            });
    }
    
    function loadBlogs(page = 0) {
        currentPage = page;
        let url = `/api/public/blogs?page=${page}&size=9`;
        if (currentCategory) {
            url = `/api/public/blogs/category/${currentCategory}?page=${page}&size=9`;
        }
        
        const searchQuery = document.getElementById('searchInput').value.trim();
        if (searchQuery) {
            url = `/api/public/blogs/search?keyword=${encodeURIComponent(searchQuery)}&page=${page}&size=9`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    displayBlogs(data.data.content);
                    displayPagination(data.data);
                    document.getElementById('resultsCount').textContent = `Tìm thấy ${data.data.totalElements} bài viết`;
                }
            })
            .catch(error => {
                console.error('Error loading blogs:', error);
                document.getElementById('blogGrid').innerHTML = '<div class="col-12"><div class="alert alert-danger">Lỗi tải bài viết</div></div>';
            });
    }
    
    function displayBlogs(blogs) {
        const container = document.getElementById('blogGrid');
        if (!blogs || blogs.length === 0) {
            container.innerHTML = '<div class="col-12"><div class="alert alert-info">Không có bài viết nào</div></div>';
            return;
        }
        
        let html = '';
        blogs.forEach(blog => {
            if (currentView === 'grid') {
                html += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="blog-card">
                            ${blog.thumbnailUrl ? `<img src="${blog.thumbnailUrl}" alt="${blog.title}">` : '<div class="blog-card-no-image"><i class="bi bi-image"></i></div>'}
                            <div class="blog-card-body">
                                <div class="blog-card-meta">
                                    <span><i class="bi bi-calendar"></i> ${blog.publishedDate || blog.createdDate}</span>
                                    <span><i class="bi bi-eye"></i> ${blog.viewCount || 0}</span>
                                </div>
                                <h5>${blog.title}</h5>
                                <p>${blog.shortSummary || blog.summary || ''}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-primary">${blog.categoryName}</span>
                                    <a href="/blog/${blog.slug}" class="btn btn-sm btn-outline-primary">Đọc thêm <i class="bi bi-arrow-right"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="col-12 mb-3">
                        <div class="blog-card blog-card-list">
                            <div class="row g-0">
                                <div class="col-md-3">
                                    ${blog.thumbnailUrl ? `<img src="${blog.thumbnailUrl}" alt="${blog.title}">` : '<div class="blog-card-no-image"><i class="bi bi-image"></i></div>'}
                                </div>
                                <div class="col-md-9">
                                    <div class="blog-card-body">
                                        <div class="blog-card-meta">
                                            <span><i class="bi bi-calendar"></i> ${blog.publishedDate || blog.createdDate}</span>
                                            <span><i class="bi bi-eye"></i> ${blog.viewCount || 0}</span>
                                            <span class="badge bg-primary">${blog.categoryName}</span>
                                        </div>
                                        <h5>${blog.title}</h5>
                                        <p>${blog.shortSummary || blog.summary || ''}</p>
                                        <a href="/blog/${blog.slug}" class="btn btn-sm btn-outline-primary">Đọc thêm <i class="bi bi-arrow-right"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        container.innerHTML = html;
    }
    
    function displayPagination(pageData) {
        const nav = document.getElementById('paginationNav');
        const pagination = document.getElementById('pagination');
        
        if (pageData.totalPages <= 1) {
            nav.style.display = 'none';
            return;
        }
        
        nav.style.display = 'block';
        let html = '';
        
        // Previous
        html += `<li class="page-item ${pageData.first ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadBlogs(${currentPage - 1}); return false;">Trước</a>
        </li>`;
        
        // Pages
        for (let i = 0; i < pageData.totalPages; i++) {
            if (i === 0 || i === pageData.totalPages - 1 || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadBlogs(${i}); return false;">${i + 1}</a>
                </li>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }
        
        // Next
        html += `<li class="page-item ${pageData.last ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadBlogs(${currentPage + 1}); return false;">Sau</a>
        </li>`;
        
        pagination.innerHTML = html;
    }
    
    function loadPopularPosts() {
        fetch('/api/public/blogs/top-viewed?size=5')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('popularPosts');
                if (data.success && data.data && data.data.length > 0) {
                    let html = '<ul class="list-unstyled">';
                    data.data.forEach(blog => {
                        html += `
                            <li class="popular-post-item">
                                <a href="/blog/${blog.slug}">
                                    <h6>${blog.title}</h6>
                                    <small><i class="bi bi-eye"></i> ${blog.viewCount || 0} lượt xem</small>
                                </a>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p class="text-muted">Chưa có bài viết</p>';
                }
            })
            .catch(error => {
                console.error('Error loading popular posts:', error);
            });
    }
    
    function filterByCategory(categoryId) {
        currentCategory = categoryId;
        currentPage = 0;
        loadBlogs(0);
        
        // Update active state
        document.querySelectorAll('.category-link').forEach(link => {
            link.classList.remove('active');
        });
        event.target.classList.add('active');
    }
    
    function searchBlogs() {
        currentPage = 0;
        currentCategory = null;
        loadBlogs(0);
    }
    
    function changeView(view) {
        currentView = view;
        document.querySelectorAll('[data-view]').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-view="${view}"]`).classList.add('active');
        
        const container = document.getElementById('blogGrid');
        if (view === 'list') {
            container.classList.remove('row');
        } else {
            container.classList.add('row');
        }
        
        // Reload to apply new view
        fetch('/api/public/blogs?page=' + currentPage + '&size=9')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    displayBlogs(data.data.content);
                }
            });
    }
    
    // Search on Enter key
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchBlogs();
        }
    });
</script>
</body>
</html>
