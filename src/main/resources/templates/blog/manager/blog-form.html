<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${isEdit != null and isEdit ? 'Edit Blog' : 'Create New Blog'}">Create New Blog</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        .preview-container {
            position: relative;
            display: inline-block;
            margin-top: 10px;
        }
        .remove-preview-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 2px 8px;
            font-size: 12px;
        }
    </style>
</head>
<body>

<div th:replace="common/sidebar-header :: role-sidebar">
    <th:block th:fragment="content">
        <div class="container-fluid px-4 py-4">

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h2 th:text="${isEdit != null and isEdit ? 'Edit Blog' : 'Create New Blog'}">Create New Blog</h2>
    <div>
        <a th:href="@{/manager/blogs}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
</div>

<!-- Flash Messages -->
<div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle"></i> <span th:text="${error}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<!-- Blog Form -->
<form th:method="post" 
      enctype="multipart/form-data"
      th:object="${blog}"
      th:action="@{${isEdit != null and isEdit ? '/manager/blogs/edit/' + blog.blogId : '/manager/blogs/create'}}">                
    <!-- Hidden fields to preserve data in edit mode -->
    <input type="hidden" name="blogId" th:value="${blog.blogId}" th:if="${isEdit != null and isEdit}" />
    <input type="hidden" name="thumbnailImage" th:value="${blog.thumbnailImage}" th:if="${isEdit != null and isEdit}" />
    <input type="hidden" name="bannerImage" th:value="${blog.bannerImage}" th:if="${isEdit != null and isEdit}" />
    
    <div class="row">
        <!-- Left Column -->
        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" 
                               class="form-control" 
                               th:classappend="${#fields.hasErrors('title')} ? 'is-invalid'"
                               th:field="*{title}" 
                               required 
                               maxlength="255"
                               placeholder="Enter blog title...">
                        <div class="text-danger small mt-1" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Slug</label>
                        <input type="text" 
                               class="form-control" 
                               th:field="*{slug}" 
                               maxlength="255"
                               placeholder="auto-generated-from-title">
                        <small class="text-muted">Leave empty to auto-generate from title</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Short Description <span class="text-danger">*</span></label>
                        <textarea class="form-control" 
                                  th:classappend="${#fields.hasErrors('excerpt')} ? 'is-invalid'"
                                  th:field="*{excerpt}" 
                                  rows="3" 
                                  required
                                  maxlength="500"
                                  placeholder="Brief description of blog content..."></textarea>
                        <div class="text-danger small mt-1" th:if="${#fields.hasErrors('excerpt')}" th:errors="*{excerpt}"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Content <span class="text-danger">*</span></label>
                        <textarea class="form-control" 
                                  th:classappend="${#fields.hasErrors('content')} ? 'is-invalid'"
                                  th:field="*{content}" 
                                  rows="15"
                                  required
                                  placeholder="Write blog content..."></textarea>
                        <div class="text-danger small mt-1" th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></div>
                        <small class="text-muted">Supports basic HTML: &lt;p&gt;, &lt;br&gt;, &lt;strong&gt;, &lt;em&gt;, &lt;ul&gt;, &lt;ol&gt;, &lt;li&gt;, &lt;a&gt;</small>
                    </div>

                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-4">
            <!-- Publish Settings -->
            <div class="card mb-3">
                <div class="card-header">
                    <strong>Publish Settings</strong>
                </div>
                <div class="card-body">
                    <!-- Status (Always Display as Readonly) -->
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <input type="text" class="form-control" 
                               th:value="${isEdit != null and isEdit ? blog.status : 'DRAFT'}" 
                               readonly>
                        <input type="hidden" th:field="*{status}">
                        <small class="text-muted" th:if="${isEdit != null and isEdit}">Use Publish/Unpublish/Archive buttons in blog list to change status</small>
                        <small class="text-muted" th:unless="${isEdit != null and isEdit}">New blogs are created as Draft by default</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Category <span class="text-danger">*</span></label>
                        <select class="form-select" 
                                th:classappend="${#fields.hasErrors('categoryId')} ? 'is-invalid'"
                                th:field="*{categoryId}" 
                                required>
                            <option value="">-- Select category --</option>
                            <option th:each="category : ${categories}" 
                                    th:value="${category.categoryId}" 
                                    th:text="${category.categoryName}">
                            </option>
                        </select>
                        <div class="text-danger small mt-1" th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}"></div>
                    </div>
                </div>
            </div>

            <!-- Thumbnail Image -->
            <div class="card mb-3">
                <div class="card-header">
                    <strong><i class="bi bi-image"></i> Thumbnail Image</strong>
                </div>
                <div class="card-body">
                    <!-- Show existing thumbnail in edit mode -->
                    <div th:if="${isEdit != null and isEdit and blog.thumbnailImage != null}" class="mb-2">
                        <p class="small text-muted mb-1">Current image:</p>
                        <img th:src="@{${blog.thumbnailImage}}" class="image-preview" alt="Current thumbnail">
                    </div>
                    
                    <input type="file" 
                           class="form-control" 
                           name="thumbnailFile" 
                           id="thumbnailFile"
                           accept="image/*"
                           onchange="previewThumbnail(event)">
                    <small class="text-muted">JPG, PNG, GIF (max 5MB)<span th:if="${isEdit != null and isEdit}"> - Only upload if you want to change</span></small>
                    
                    <div id="thumbnailPreview" style="display: none;" class="text-center">
                        <div class="preview-container">
                            <img id="thumbnailPreviewImg" class="image-preview" alt="Thumbnail preview">
                            <button type="button" class="btn btn-danger btn-sm remove-preview-btn" onclick="removeThumbnail()">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Banner Image -->
            <div class="card mb-3">
                <div class="card-header">
                    <strong><i class="bi bi-card-image"></i> Banner Image</strong>
                </div>
                <div class="card-body">
                    <!-- Show existing banner in edit mode -->
                    <div th:if="${isEdit != null and isEdit and blog.bannerImage != null}" class="mb-2">
                        <p class="small text-muted mb-1">Current image:</p>
                        <img th:src="@{${blog.bannerImage}}" class="image-preview" alt="Current banner">
                    </div>
                    
                    <input type="file" 
                           class="form-control" 
                           name="bannerFile" 
                           id="bannerFile"
                           accept="image/*"
                           onchange="previewBanner(event)">
                    <small class="text-muted">JPG, PNG, GIF (max 5MB) - Displayed at the top of the post<span th:if="${isEdit != null and isEdit}"> - Only upload if you want to change</span></small>
                    
                    <div id="bannerPreview" style="display: none;" class="text-center">
                        <div class="preview-container">
                            <img id="bannerPreviewImg" class="image-preview" alt="Banner preview">
                            <button type="button" class="btn btn-danger btn-sm remove-preview-btn" onclick="removeBanner()">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule Publish -->
            <div class="card mb-3">
                <div class="card-header">
                    <strong><i class="bi bi-calendar-event"></i> Schedule Publish</strong>
                </div>
                <div class="card-body">
                    <input type="datetime-local" 
                           class="form-control" 
                           th:field="*{scheduledPublishAt}" 
                           id="scheduledPublishAt">
                    <small class="text-muted">Leave empty to publish immediately</small>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="card">
                <div class="card-body">
                    <button type="submit" class="btn btn-primary w-100 mb-2">
                        <i class="bi bi-save"></i> <span th:text="${isEdit != null and isEdit ? 'Update' : 'Create'}">Create</span>
                    </button>
                    <a th:href="@{/manager/blogs}" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                </div>
            </div>
        </div>
    </div>
</form>

</div>
    </th:block>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Thumbnail preview
    function previewThumbnail(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('thumbnailPreviewImg').src = e.target.result;
                document.getElementById('thumbnailPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    function removeThumbnail() {
        document.getElementById('thumbnailFile').value = '';
        document.getElementById('thumbnailPreview').style.display = 'none';
        document.getElementById('thumbnailPreviewImg').src = '';
    }

    // Banner preview
    function previewBanner(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('bannerPreviewImg').src = e.target.result;
                document.getElementById('bannerPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    function removeBanner() {
        document.getElementById('bannerFile').value = '';
        document.getElementById('bannerPreview').style.display = 'none';
        document.getElementById('bannerPreviewImg').src = '';
    }

</script>
</body>
</html>
