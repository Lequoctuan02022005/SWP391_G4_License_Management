<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>License Account</title>
    <link rel="stylesheet" th:href="@{/css/license-account-detail.css}" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
</head>

<body>
<div class="container">
    <div class="card">

        <div class="top">
            <h1>License Account #<span th:text="${la.licenseAccountId}">0</span></h1>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <a class="btn btn-ghost" th:href="@{/customer/license-accounts}">‚Üê Danh s√°ch</a>

                <a class="btn btn-dark"
                   th:if="${la.order != null}"
                   th:href="@{/customer/orders/}">
                    ‚Üê Back to order
                </a>
            </div>
        </div>

        <div th:if="${successMsg != null and !#strings.isEmpty(successMsg)}"
             class="msg msg-ok" th:text="${successMsg}">OK</div>
        <div th:if="${errorMsg != null and !#strings.isEmpty(errorMsg)}"
             class="msg msg-err" th:text="${errorMsg}">ERR</div>

        <div class="grid">

            <div class="box">
                <div class="label">Tool</div>
                <div class="value">
                    <b th:text="${la.license != null and la.license.tool != null ? la.license.tool.toolName : '(N/A)'}">Tool</b>
                    <div class="muted" th:if="${la.license != null and la.license.tool != null}">
                        Login method: <b th:text="${la.license.tool.loginMethod}">USER_PASSWORD</b>
                    </div>
                </div>
            </div>

            <div class="box">
                <div class="label">License package (latest)</div>
                <div class="value">
                    <b th:text="${la.license != null ? la.license.name : '(N/A)'}">License</b>
                    <div class="muted" th:if="${la.license != null and la.license.durationDays != null}">
                        Duration: <span th:text="${la.license.durationDays}">0</span> ng√†y
                    </div>
                </div>
            </div>

            <div class="box">
                <div class="label">Status</div>
                <div class="value">
                    <span class="badge b-active" th:if="${la.status != null and la.status.name() == 'ACTIVE'}">ACTIVE</span>
                    <span class="badge b-expired" th:if="${la.status != null and la.status.name() == 'EXPIRED'}">EXPIRED</span>
                    <span class="badge b-revoked" th:if="${la.status != null and la.status.name() == 'REVOKED'}">REVOKED</span>
                    <span class="badge b-null" th:if="${la.status == null}">N/A</span>

                    <div class="muted" style="margin-top:6px;">
                        Used: <b th:text="${la.used}">false</b>
                    </div>
                </div>
            </div>

            <div class="box">
                <div class="label">Validity</div>
                <div class="value">
                    <div class="muted">Start</div>
                    <b th:text="${la.startDate != null ? #temporals.format(la.startDate,'dd/MM/yyyy HH:mm') : '(N/A)'}">--</b>
                    <div class="sep"></div>
                    <div class="muted">End</div>
                    <b th:text="${la.endDate != null ? #temporals.format(la.endDate,'dd/MM/yyyy HH:mm') : '(N/A)'}">--</b>
                </div>
            </div>

            <div class="box full">
                <div class="label">Login info</div>
                <div class="value">

                    <!-- TOKEN -->
                    <div th:if="${la.token != null}">
                        <div class="muted">Token</div>
                        <b class="mono" th:text="${la.token}">token</b>
                        <div class="muted" style="margin-top:6px;">(Tool TOKEN kh√¥ng cho edit credential)</div>
                    </div>

                    <!-- USER/PASS -->
                    <div th:if="${la.token == null}">
                        <div class="pwd-row">
                            <div>
                                <div class="muted">Username</div>
                                <b class="mono" th:text="${la.username != null ? la.username : '(N/A)'}">u</b>
                            </div>

                            <div>
                                <div class="muted">Password</div>

                                <div class="pwd-actions">
                                    <input
                                            id="laPwdInput"
                                            class="mono"
                                            type="password"
                                            th:value="${la.password != null ? la.password : ''}"
                                            readonly
                                            style="min-width:240px;"
                                    />

                                    <button type="button"
                                            class="pwd-btn"
                                            onclick="togglePwdField('laPwdInput', this)">
                                        üëÅ <span class="muted" style="font-weight:900;">Xem</span>
                                    </button>
                                </div>

                                <div class="muted" style="margin-top:6px;">(·∫®n/Hi·ªán m·∫≠t kh·∫©u)</div>
                            </div>
                        </div>

                        <div class="muted" style="margin-top:6px;">
                            Tip: n·∫øu mu·ªën ƒë·ªïi m·∫≠t kh·∫©u, b·∫•m ‚ÄúEdit‚Äù.
                        </div>
                    </div>

                </div>
            </div>

            <div class="box full">
                <div class="label">Actions</div>
                <div class="value" style="display:flex; gap:10px; flex-wrap:wrap;">

                    <!-- EDIT: ch·ªâ khi USER_PASSWORD + ACTIVE -->
                    <button class="btn btn-primary"
                            type="button"
                            th:if="${la.license != null and la.license.tool != null
                          and la.license.tool.loginMethod != null
                          and la.license.tool.loginMethod.name() == 'USER_PASSWORD'
                          and la.status != null and la.status.name() == 'ACTIVE'}"
                            onclick="openModal('editModal')">
                        Edit
                    </button>

                    <button class="btn btn-dark"
                            type="button"
                            th:if="${la.status == null or la.status.name() != 'REVOKED'}"
                            onclick="openModal('renewModal')">
                        Renew
                    </button>
                </div>

                <div class="muted" style="margin-top:8px;">
                    N·∫øu h·∫øt h·∫°n: h·ªá th·ªëng c√≥ th·ªÉ hi·ªÉn th·ªã EXPIRED v√† v·∫´n cho Renew (tu·ª≥ rule backend).
                </div>
            </div>

        </div>

    </div>
</div>

<!-- ================== EDIT MODAL ================== -->
<div id="editModal" class="overlay" onclick="overlayClose(event,'editModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="mhead">
            <h2>Edit License Account</h2>
            <button class="close" type="button" onclick="closeModal('editModal')">‚úï</button>
        </div>

        <form class="form"
              th:action="@{/customer/license-accounts/{id}/edit(id=${la.licenseAccountId})}"
              th:object="${editDto}"
              method="post">

            <input type="hidden" th:if="${_csrf != null}"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}" />

            <div class="field">
                <label>Username</label>
                <input type="text" th:field="*{username}" placeholder="Nh·∫≠p username" required minlength="3" maxlength="255">
                <div class="err" th:if="${#fields.hasErrors('username')}" th:errors="*{username}">err</div>
            </div>

            <div class="field">
                <label>Password</label>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <input id="pwd" type="password" th:field="*{password}" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi"
                           required minlength="4" maxlength="255" style="flex:1; min-width:240px;">
                    <button type="button" class="close" onclick="togglePwd()">üëÅ</button>
                </div>
                <div class="err" th:if="${#fields.hasErrors('password')}" th:errors="*{password}">err</div>
            </div>

            <div class="rowbtn">
                <button class="btn btn-ghost" type="button" onclick="closeModal('editModal')">Cancel</button>
                <button class="btn btn-primary" type="submit">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- ================== RENEW MODAL ================== -->
<div id="renewModal" class="overlay" onclick="overlayClose(event,'renewModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="mhead">
            <h2>Renew License</h2>
            <button class="close" type="button" onclick="closeModal('renewModal')">‚úï</button>
        </div>

        <form class="form"
              th:action="@{/customer/license-accounts/{id}/renew(id=${la.licenseAccountId})}"
              th:object="${renewForm}"
              method="post">

            <input type="hidden" th:if="${_csrf != null}"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}" />

            <input type="hidden" name="licenseAccountId" th:value="${la.licenseAccountId}"/>

            <div class="field">
                <label>Ch·ªçn g√≥i gia h·∫°n</label>
                <select name="licenseId" required>
                    <option value="" selected>-- Ch·ªçn g√≥i --</option>
                    <option th:each="p : ${renewPackages}"
                            th:value="${p.licenseId}"
                            th:text="${p.name + ' ¬∑ ' + (p.durationDays != null ? p.durationDays : 0) + ' ng√†y ¬∑ ' + (p.price != null ? p.price : 0) + ' VND'}">
                    </option>
                </select>
                <div class="err" th:if="${renewError != null}" th:text="${renewError}">err</div>
            </div>

            <div class="muted">
                B·∫•m ‚ÄúPay via VNPay‚Äù ƒë·ªÉ ƒëi t·ªõi flow thanh to√°n (backend s·∫Ω init transaction).
            </div>

            <div class="rowbtn">
                <button class="btn btn-ghost" type="button" onclick="closeModal('renewModal')">Close</button>
                <button class="btn btn-dark" type="submit">Pay via VNPay</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openModal(id){ document.getElementById(id).style.display = 'flex'; }
    function closeModal(id){ document.getElementById(id).style.display = 'none'; }
    function overlayClose(e, id){ if(e.target && e.target.id === id) closeModal(id); }

    // Toggle password in EDIT modal
    function togglePwd(){
        const el = document.getElementById('pwd');
        if(!el) return;
        el.type = (el.type === 'password') ? 'text' : 'password';
    }

    // Toggle password field (Login info)
    function togglePwdField(inputId, btn){
        const el = document.getElementById(inputId);
        if(!el) return;

        const isHidden = el.type === 'password';
        el.type = isHidden ? 'text' : 'password';

        if(btn){
            btn.innerHTML = isHidden
                ? 'üôà <span class="muted" style="font-weight:900;">Che</span>'
                : 'üëÅ <span class="muted" style="font-weight:900;">Xem</span>';
        }
    }

    // Auto open modal from server flags
    const openEdit = /*[[${openEditModal}]]*/ false;
    if(openEdit){ openModal('editModal'); }

    const openRenew = /*[[${openRenewModal}]]*/ false;
    if(openRenew){ openModal('renewModal'); }
</script>

</body>
</html>
