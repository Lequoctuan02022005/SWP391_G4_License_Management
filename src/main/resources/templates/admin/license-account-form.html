<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${mode=='create' ? 'Create License Account' : 'Edit License Account'}"></title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>

    <style>
        body { background:#f5f7fa; font-family:"Inter", sans-serif; }
        .page-title { font-weight:700; font-size:28px; }
        .card { border-radius:12px; }
        .hint { color:#6b7280; font-size:12px; }
        .action-btn { border-radius:6px; padding:6px 14px; }
    </style>
</head>
<body>

<div th:replace="admin/admin-header :: adminHeader"></div>

<div class="container mt-5" style="max-width: 920px;">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="page-title" th:text="${mode=='create' ? 'Create License Account' : 'Edit License Account'}"></h2>
        <a class="btn btn-outline-dark action-btn" th:href="@{/system-admin/license-accounts}">Back</a>
    </div>

    <div th:if="${error}" class="alert alert-danger shadow-sm" th:text="${error}"></div>

    <!-- ================= CREATE FORM ================= -->
    <form th:if="${mode == 'create'}"
          th:action="@{/system-admin/license-accounts/create}"
          th:object="${form}" method="post"
          class="card p-4 shadow-sm">

        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <div class="row g-3">

            <div class="col-12">
                <label class="form-label fw-semibold">License</label>
                <select class="form-select" th:field="*{licenseId}" id="licenseSelectCreate">
                    <option value="">-- Select license --</option>
                    <option th:each="l : ${licenses}"
                            th:value="${l.licenseId}"
                            th:text="${(l.tool != null ? l.tool.toolName : 'N/A') + ' / ' + (l.name != null ? l.name : '')}"
                            th:attr="data-method=${(l.tool != null and l.tool.loginMethod != null) ? l.tool.loginMethod : ''}">
                    </option>
                </select>
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('licenseId')}" th:errors="*{licenseId}"></div>
                <div class="hint">Chọn license để biết tool login_method (TOKEN hoặc USER_PASSWORD)</div>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold">Status</label>
                <select class="form-select" th:field="*{status}">
                    <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}"></option>
                </select>
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('status')}" th:errors="*{status}"></div>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold">Used</label>
                <select class="form-select" th:field="*{used}">
                    <option th:value="false">false</option>
                    <option th:value="true">true</option>
                </select>
            </div>

            <!-- datetime-local: dùng th:value format để chắc chắn render đúng -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Start Date</label>
                <input class="form-control" type="datetime-local" name="startDate"
                       th:value="${form.startDate != null ? #temporals.format(form.startDate, 'yyyy-MM-dd''T''HH:mm') : ''}">
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('startDate')}" th:errors="*{startDate}"></div>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold">End Date</label>
                <input class="form-control" type="datetime-local" name="endDate"
                       th:value="${form.endDate != null ? #temporals.format(form.endDate, 'yyyy-MM-dd''T''HH:mm') : ''}">
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('endDate')}" th:errors="*{endDate}"></div>
            </div>

            <div class="col-md-6" id="userPassBlockCreate">
                <label class="form-label fw-semibold">Username</label>
                <input class="form-control" type="text" th:field="*{username}" placeholder="username (USER_PASSWORD)"/>
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></div>

                <label class="form-label fw-semibold mt-3">Password</label>
                <input class="form-control" type="text" th:field="*{password}" placeholder="password (USER_PASSWORD)"/>
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></div>
            </div>

            <div class="col-md-6" id="tokenBlockCreate">
                <label class="form-label fw-semibold">Token</label>
                <input class="form-control" type="text" th:field="*{token}" placeholder="token (TOKEN)"/>
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('token')}" th:errors="*{token}"></div>
                <div class="hint">Token chỉ gồm chữ/số/_/- và không có khoảng trắng</div>
            </div>

            <div class="col-12 d-flex gap-2 mt-2">
                <button class="btn btn-primary action-btn" type="submit">Save</button>
                <a class="btn btn-secondary action-btn" th:href="@{/system-admin/license-accounts}">Cancel</a>
            </div>
        </div>
    </form>

    <!-- ================= EDIT FORM ================= -->
    <form th:if="${mode == 'edit'}"
          th:action="@{/system-admin/license-accounts/{id}/edit(id=${id})}"
          th:object="${form}" method="post"
          class="card p-4 shadow-sm">

        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <div class="row g-3">

            <div class="col-12">
                <label class="form-label fw-semibold">License</label>
                <select class="form-select" th:field="*{licenseId}" id="licenseSelectEdit">
                    <option value="">-- Select license --</option>
                    <option th:each="l : ${licenses}"
                            th:value="${l.licenseId}"
                            th:text="${(l.tool != null ? l.tool.toolName : 'N/A') + ' / ' + (l.name != null ? l.name : '')}"
                            th:attr="data-method=${(l.tool != null and l.tool.loginMethod != null) ? l.tool.loginMethod : ''}">
                    </option>
                </select>
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('licenseId')}" th:errors="*{licenseId}"></div>
                <div class="hint">Chọn license để biết tool login_method (TOKEN hoặc USER_PASSWORD)</div>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold">Status</label>
                <select class="form-select" th:field="*{status}">
                    <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}"></option>
                </select>
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('status')}" th:errors="*{status}"></div>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold">Used</label>
                <select class="form-select" th:field="*{used}">
                    <option th:value="false">false</option>
                    <option th:value="true">true</option>
                </select>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold">Start Date</label>
                <input class="form-control" type="datetime-local" name="startDate"
                       th:value="${form.startDate != null ? #temporals.format(form.startDate, 'yyyy-MM-dd''T''HH:mm') : ''}">
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('startDate')}" th:errors="*{startDate}"></div>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold">End Date</label>
                <input class="form-control" type="datetime-local" name="endDate"
                       th:value="${form.endDate != null ? #temporals.format(form.endDate, 'yyyy-MM-dd''T''HH:mm') : ''}">
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('endDate')}" th:errors="*{endDate}"></div>
            </div>

            <div class="col-md-6" id="userPassBlockEdit">
                <label class="form-label fw-semibold">Username</label>
                <input class="form-control" type="text" th:field="*{username}" placeholder="username (USER_PASSWORD)"/>
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></div>

                <label class="form-label fw-semibold mt-3">Password</label>
                <input class="form-control" type="text" th:field="*{password}" placeholder="password (USER_PASSWORD)"/>
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></div>
            </div>

            <div class="col-md-6" id="tokenBlockEdit">
                <label class="form-label fw-semibold">Token</label>
                <input class="form-control" type="text" th:field="*{token}" placeholder="token (TOKEN)"/>
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('token')}" th:errors="*{token}"></div>
                <div class="hint">Token chỉ gồm chữ/số/_/- và không có khoảng trắng</div>
            </div>

            <div class="col-12 d-flex gap-2 mt-2">
                <button class="btn btn-primary action-btn" type="submit">Save</button>
                <a class="btn btn-secondary action-btn" th:href="@{/system-admin/license-accounts}">Cancel</a>
            </div>
        </div>
    </form>

</div>

<script>
    const licenseSelect =
        document.getElementById('licenseSelectCreate') ||
        document.getElementById('licenseSelectEdit');

    const userPassBlock =
        document.getElementById('userPassBlockCreate') ||
        document.getElementById('userPassBlockEdit');

    const tokenBlock =
        document.getElementById('tokenBlockCreate') ||
        document.getElementById('tokenBlockEdit');

    function setDisabled(block, disabled) {
        if (!block) return;
        block.querySelectorAll('input, select, textarea').forEach(el => {
            el.disabled = disabled;
            if (disabled) el.value = ""; // clear để không submit rác
        });
    }

    function toggleByMethod() {
        if (!licenseSelect || !userPassBlock || !tokenBlock) return;

        const opt = licenseSelect.options[licenseSelect.selectedIndex];
        const method = (opt && opt.getAttribute('data-method'))
            ? String(opt.getAttribute('data-method')).toUpperCase()
            : '';

        if (method === 'TOKEN') {
            tokenBlock.style.display = 'block';
            userPassBlock.style.display = 'none';

            setDisabled(tokenBlock, false);
            setDisabled(userPassBlock, true);
        } else if (method === 'USER_PASSWORD') {
            tokenBlock.style.display = 'none';
            userPassBlock.style.display = 'block';

            setDisabled(tokenBlock, true);
            setDisabled(userPassBlock, false);
        } else {
            tokenBlock.style.display = 'block';
            userPassBlock.style.display = 'block';

            setDisabled(tokenBlock, false);
            setDisabled(userPassBlock, false);
        }
    }

    if (licenseSelect) {
        licenseSelect.addEventListener('change', toggleByMethod);
        toggleByMethod();
    }
</script>


</body>
</html>
