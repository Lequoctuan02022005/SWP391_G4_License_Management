<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link th:href="@{/css/toollist.css}" rel="stylesheet">
    <link th:href="@{/css/home.css}" rel="stylesheet">

</head>
<body>
<!--Header-->
<div th:replace="common/header :: header"></div>


<main class="tl-page">

    <!-- TIÊU ĐỀ -->
    <section class="tl-page-header">
        <h1>Danh sách Tool</h1>
        <p>Khám phá các tool đã được đăng, hoặc quản lý tool của bạn (nếu là Seller).</p>
    </section>

    <section class="tl-layout">

        <!-- SIDEBAR FILTER -->
        <aside class="tl-filter-sidebar">

            <h2 class="tl-filter-title">Bộ lọc</h2>

            <!-- Form filter GET /toollist -->
            <form th:action="@{/toollist}" method="get" class="tl-filter-form">

                <!-- SEARCH -->
                <div class="tl-filter-group">
                    <label for="keyword">Từ khóa</label>
                    <input id="keyword"
                           type="text"
                           name="keyword"
                           placeholder="Tìm theo tên / mô tả"
                           th:value="${keyword}">
                </div>

                <!-- LOGIN METHOD -->
                <div class="tl-filter-group">
                    <label for="loginMethod">Hình thức đăng nhập</label>
                    <select id="loginMethod" name="loginMethod">
                        <option value="" th:selected="${loginMethod == null or loginMethod == ''}">Tất cả</option>
                        <option value="USER_PASSWORD"
                                th:selected="${loginMethod == 'USER_PASSWORD'}">
                            USER_PASSWORD
                        </option>
                        <option value="TOKEN"
                                th:selected="${loginMethod == 'TOKEN'}">
                            TOKEN
                        </option>
                    </select>
                </div>

                <!-- STATUS: chỉ hiện khi là SELLER -->
                <div class="tl-filter-group" th:if="${isSeller}">
                    <label for="status">Trạng thái</label>
                    <select id="status" name="status">
                        <option value=""
                                th:selected="${status == null or status == ''}">
                            Tất cả
                        </option>
                        <option value="PENDING"
                                th:selected="${status == 'PENDING'}">
                            PENDING
                        </option>
                        <option value="APPROVED"
                                th:selected="${status == 'APPROVED'}">
                            APPROVED
                        </option>
                        <option value="REJECTED"
                                th:selected="${status == 'REJECTED'}">
                            REJECTED
                        </option>
                        <option value="PUBLISHED"
                                th:selected="${status == 'PUBLISHED'}">
                            PUBLISHED
                        </option>
                        <option value="DEACTIVATED"
                                th:selected="${status == 'DEACTIVATED'}">
                            DEACTIVATED
                        </option>
                    </select>
                </div>

                <button type="submit" class="tl-btn tl-btn-primary tl-btn-full">
                    Áp dụng
                </button>

                <a th:href="@{/toollist}" class="tl-btn tl-btn-secondary tl-btn-full tl-mt-8">
                    Xóa lọc
                </a>

            </form>
        </aside>

        <!-- CONTENT -->
        <section class="tl-content">

            <!-- THANH ACTION TRÊN -->
            <div class="tl-top-bar">
                <div class="tl-top-left">
                    <span class="tl-result"
                          th:if="${tools != null}">
                        Tìm thấy
                        <strong th:text="${#lists.size(tools)}">0</strong>
                        tool.
                    </span>
                </div>

                <!-- Nút ADD cho SELLER -->
                <div class="tl-top-right" sec:authorize="hasRole('SELLER')">
                    <a th:href="@{/tools/seller/add}" class="tl-btn tl-btn-primary">
                        + Thêm Tool
                    </a>
                </div>
            </div>

            <!-- GRID TOOL -->
            <div class="tl-grid" th:if="${tools != null and !#lists.isEmpty(tools)}">

                <article class="tl-card"
                         th:each="tool : ${tools}">

                    <!-- ẢNH + BADGE TRẠNG THÁI -->
                    <div class="tl-card-image-wrapper">
                        <img th:src="@{ ${tool.image}}">
                             alt="Tool image"
                             class="tl-card-image" />

                        <!-- BADGE trạng thái: hiển thị cho mọi role, nhưng Seller quan tâm hơn -->
                        <span class="tl-badge"
                              th:switch="${tool.status}">

                        <span th:case="'PUBLISHED'" class="tl-badge tl-badge-published">
                            [[${tool.status}]]
                        </span>

                        <span th:case="'PENDING'" class="tl-badge tl-badge-pending">
                            [[${tool.status}]]
                        </span>

                        <span th:case="'REJECTED'" class="tl-badge tl-badge-rejected">
                            [[${tool.status}]]
                        </span>

                        <span th:case="'DEACTIVATED'" class="tl-badge tl-badge-deactivated">
                            [[${tool.status}]]
                        </span>

                                                <!-- default -->
                        <span th:case="*">UNKNOWN</span>
                    </span>

                    </div>

                    <!-- NỘI DUNG -->
                    <div class="tl-card-body">
                        <!-- TÊN TOOL -->
                        <h3 class="tl-card-title"
                            th:text="${tool.toolName}">
                            Tên tool
                        </h3>

                        <!-- SELLER (đơn giản, nếu có) -->
                        <p class="tl-card-seller"
                           th:if="${tool.seller != null}">
                            Seller:
                            <span th:text="${tool.seller.fullName}"
                                  class="tl-card-seller-name">
                                Seller Name
                            </span>
                        </p>

                        <!-- RATING + REVIEWS (nếu có dữ liệu) -->
                        <div class="tl-card-rating">
                            <span class="tl-stars">★</span>
                            <span class="tl-rating-value"
                                  th:text="${tool.averageRating != null ? #numbers.formatDecimal(tool.averageRating,1,1) : '0.0'}">
                                0.0
                            </span>
                            <span class="tl-rating-count">
                                (<span th:text="${tool.totalReviews != null ? tool.totalReviews : 0}">0</span> đánh giá)
                            </span>
                        </div>

                        <!-- MÔ TẢ NGẮN -->
                        <p class="tl-card-desc"
                           th:text="${tool.description}">
                            Mô tả tool...
                        </p>

                        <!-- SỐ LƯỢNG -->
                        <div class="tl-card-stock">
                            <span>
                                Tồn kho:
                                <strong th:text="${tool.availableQuantity != null ? tool.availableQuantity : 0}">
                                    0
                                </strong>
                                /
                                <span th:text="${tool.quantity}">
                                    0
                                </span>
                            </span>
                        </div>
                    </div>

                    <!-- FOOTER ACTION -->
                    <div class="tl-card-footer">

                        <!-- Xem chi tiết: luôn có -->
                        <a th:href="@{'/tools/detail/' + ${tool.toolId}}"
                           class="tl-btn tl-btn-outline tl-btn-sm">
                            Xem chi tiết
                        </a>

                        <!-- Chức năng cho SELLER -->
                        <div class="tl-card-actions" sec:authorize="hasRole('SELLER')">

                            <!-- Toggle cho PUBLISHED / DEACTIVATED -->
                            <form th:if="${tool.status.name() == 'PUBLISHED' || tool.status.name() == 'DEACTIVATED'}"
                                  th:action="@{'/toollist/toggle/' + ${tool.toolId}}"
                                  method="post"
                                  class="tl-inline-form">

                                <button type="submit"
                                        class="tl-btn-status"
                                        th:classappend="' status-' + ${tool.status.name().toLowerCase()}"
                                        th:text="${tool.status.name()}">
                                    STATUS
                                </button>
                            </form>

                            <!-- Trạng thái khác → chỉ hiển thị -->
                            <button th:if="${tool.status.name() != 'PUBLISHED' && tool.status.name() != 'DEACTIVATED'}"
                                    class="tl-btn-status"
                                    th:classappend="' status-' + ${tool.status.name().toLowerCase()}"
                                    disabled
                                    th:text="${tool.status.name()}">
                                STATUS
                            </button>

                            <!-- EDIT chỉ cho DEACTIVATED -->
                            <a th:if="${tool.status.name() == 'DEACTIVATED'}"
                               th:href="@{'/tools/seller/edit/' + ${tool.toolId}}"
                               class="tl-btn tl-btn-success tl-btn-sm">
                                Sửa
                            </a>

                        </div>

                    </div>



                </article>

            </div>

            <!-- EMPTY STATE -->
            <div class="tl-empty" th:if="${tools == null or #lists.isEmpty(tools)}">
                Chưa có tool nào phù hợp với bộ lọc hiện tại.
            </div>

        </section>

    </section>

</main>

</body>
</html>
