<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <title>Danh sách Tool</title>

    <!-- Bootstrap + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Custom CSS -->
    <link th:href="@{/css/toollist.css}" rel="stylesheet" />
        <link th:href="@{/css/home.css}" rel="stylesheet" />
    <link th:href="@{/css/sidebar-header.css}" rel="stylesheet" />

</head>
<body>



<!-- Seller: replace entire wrapper and provide the content fragment inside the replaced element -->
<div th:if="${account.role.roleName.name() == 'SELLER'}" th:replace="common/sidebar-header :: role-sidebar">
        <th:block th:fragment="content">
        <main class="tl-page">

            <!-- PAGE HEADER -->
            <section class="tl-page-header">
                <h1>Danh sách Tool</h1>
                <p>Khám phá các tool đã được đăng, hoặc quản lý tool của bạn (nếu là Seller).</p>
            </section>

            <section class="tl-layout">

                <!-- FILTER HORIZONTAL -->
                <form th:action="@{/toollist}" method="get"
                      class="tl-filter-bar d-flex flex-wrap align-items-center justify-content-start gap-3 mb-3">
                    <!-- KEYWORDS -->
                    <div class="tl-filter-group tl-filter-inline">
                        <label for="keyword-seller">Từ khóa:</label>
                        <input id="keyword-seller" type="text" name="keyword" placeholder="Tên / mô tả" th:value="${keyword}" />
                    </div>

                    <!-- CATEGORY -->
                    <div class="tl-filter-group tl-filter-inline">
                        <label for="categoryId-seller">Danh mục:</label>
                        <select id="categoryId-seller" name="categoryId">
                            <option value="">Tất cả</option>
                            <option th:each="c : ${categories}" th:value="${c.categoryId}" th:text="${c.categoryName}"
                                    th:selected="${categoryId != null and categoryId == c.categoryId}"></option>
                        </select>
                    </div>

                    <!-- STATUS (SELLER) -->
                    <div class="tl-filter-group tl-filter-inline" th:if="${isSeller}">
                        <label for="status-seller">Trạng thái:</label>
                        <select id="status-seller" name="status">
                            <option value="" th:selected="${status == null or status == ''}">Tất cả</option>
                            <option value="PENDING" th:selected="${status == 'PENDING'}">PENDING</option>
                            <option value="APPROVED" th:selected="${status == 'APPROVED'}">APPROVED</option>
                            <option value="REJECTED" th:selected="${status == 'REJECTED'}">REJECTED</option>
                            <option value="PUBLISHED" th:selected="${status == 'PUBLISHED'}">PUBLISHED</option>
                            <option value="DEACTIVATED" th:selected="${status == 'DEACTIVATED'}">DEACTIVATED</option>
                        </select>
                    </div>

                    <!-- AUTHOR (USER) -->
                    <div class="tl-filter-group tl-filter-inline" th:if="${!isSeller}">
                        <label for="author-seller">Author:</label>
                        <select id="author-seller" name="author">
                            <option value="" th:selected="${author == null}">Tất cả</option>
                            <option th:each="s : ${sellers}" th:value="${s.accountId}" th:text="${s.fullName}"
                                    th:selected="${author != null and author == s.accountId}"></option>
                        </select>
                    </div>

                    <!-- LOGIN METHOD -->
                    <div class="tl-filter-group tl-filter-inline">
                        <label for="loginMethod-seller">Đăng nhập:</label>
                        <select id="loginMethod-seller" name="loginMethod">
                            <option value="" th:selected="${loginMethod == null or loginMethod == ''}">Tất cả</option>
                            <option value="USER_PASSWORD" th:selected="${loginMethod == 'USER_PASSWORD'}">USER_PASSWORD</option>
                            <option value="TOKEN" th:selected="${loginMethod == 'TOKEN'}">TOKEN</option>
                        </select>
                    </div>

                    <!-- PRICE RANGE -->
                    <div class="tl-filter-group tl-filter-inline">
                        <label>Giá:</label>
                        <input type="number" name="priceMin" placeholder="Từ" th:value="${priceMin}" />
                        <span>-</span>
                        <input type="number" name="priceMax" placeholder="Đến" th:value="${priceMax}" />
                    </div>

                    <!-- SORT -->
                    <div class="tl-filter-group tl-filter-inline">
                        <label for="sort-seller">Sắp xếp:</label>
                        <select id="sort-seller" name="sort">
                            <option value="" th:selected="${sort == null or sort == ''}">Mặc định</option>
                            <option value="date_desc" th:selected="${sort == 'date_desc'}">Ngày mới nhất</option>
                            <option value="date_asc" th:selected="${sort == 'date_asc'}">Ngày cũ nhất</option>
                            <option value="price_asc" th:selected="${sort == 'price_asc'}">Giá tăng</option>
                            <option value="price_desc" th:selected="${sort == 'price_desc'}">Giá giảm</option>
                        </select>
                    </div>

                    <!-- BUTTONS -->
                    <div class="tl-filter-group tl-filter-buttons tl-filter-inline">
                        <button type="submit" class="tl-btn tl-btn-primary">Áp dụng</button>
                        <a th:href="@{/toollist}" class="tl-btn tl-btn-secondary">Xóa lọc</a>
                    </div>
                </form>

                <!-- TOOL GRID CONTENT -->
                <section class="tl-content">

                    <!-- TOP BAR -->
                    <div class="tl-top-bar">
                        <div class="tl-top-right" th:if="${account.role.roleName.name() == 'SELLER'}">
                            <a th:href="@{/tools/seller/add}" class="tl-btn tl-btn-primary">+ Thêm Tool</a>
                        </div>
                    </div>

                    <!-- GRID TOOL -->
                    <div class="tl-grid" th:if="${tools != null and !#lists.isEmpty(tools)}">
                        <article class="tl-card" th:each="tool : ${tools}" th:if="${isSeller or tool.status.name() == 'PUBLISHED'}">
                            <div class="tl-card-image-wrapper">
                                <img th:src="@{${tool.image}}" alt="Tool image" class="tl-card-image" />
                                <div class="tl-sold-out-overlay" th:if="${tool.availableQuantity != null and tool.availableQuantity == 0}">HẾT HÀNG</div>
                                <span class="tl-badge" th:switch="${tool.status}">
                                    <span th:case="'PUBLISHED'" class="tl-badge tl-badge-published">[[${tool.status}]]</span>
                                    <span th:case="'PENDING'" class="tl-badge tl-badge-pending">[[${tool.status}]]</span>
                                    <span th:case="'REJECTED'" class="tl-badge tl-badge-rejected">[[${tool.status}]]</span>
                                    <span th:case="'DEACTIVATED'" class="tl-badge tl-badge-deactivated">[[${tool.status}]]</span>
                                </span>
                            </div>

                            <div class="tl-card-body">
                                <h3 class="tl-card-title" th:text="${tool.toolName}">Tên tool</h3>
                                <p class="tl-card-category" th:if="${tool.category != null}">Danh mục: <span th:text="${tool.category.categoryName}">Category</span></p>
                                <p class="tl-card-seller" th:if="${tool.seller != null}">Seller: <span th:text="${tool.seller.fullName}" class="tl-card-seller-name">Seller Name</span></p>
                                <p class="tl-card-price">
                                    Giá:
                                    <span th:if="${tool.minPrice != null and tool.maxPrice != null and tool.minPrice.compareTo(tool.maxPrice) == 0}">
                                        <strong th:text="${#numbers.formatDecimal(tool.minPrice, 0, 'COMMA', 0, 'POINT')}">0</strong> đ
                                    </span>
                                    <span th:if="${tool.minPrice != null and tool.maxPrice != null and tool.minPrice.compareTo(tool.maxPrice) != 0}">
                                        <strong th:text="${#numbers.formatDecimal(tool.minPrice, 0, 'COMMA', 0, 'POINT')}">0</strong> -
                                        <strong th:text="${#numbers.formatDecimal(tool.maxPrice, 0, 'COMMA', 0, 'POINT')}">0</strong> đ
                                    </span>
                                    <span th:if="${tool.minPrice == null}"><strong>Liên hệ</strong></span>
                                </p>
                                <div class="tl-card-licenses" th:if="${tool.licenses != null and !#lists.isEmpty(tool.licenses)}">
                                    <p class="tl-card-license-title mb-1">License:</p>
                                    <ul class="tl-license-list">
                                        <li th:each="lic : ${tool.licenses}">Gói <span th:text="${lic.durationDays}">0</span> ngày - <span th:text="${#numbers.formatDecimal(lic.price, 0, 'COMMA', 0, 'POINT')}">0</span> đ</li>
                                    </ul>
                                </div>
                                <div class="tl-card-rating">
                                    <span class="tl-stars">★</span>
                                    <span class="tl-rating-value" th:text="${tool.averageRating != null ? #numbers.formatDecimal(tool.averageRating,1,1) : '0.0'}">0.0</span>
                                    <span class="tl-rating-count">(<span th:text="${tool.totalReviews != null ? tool.totalReviews : 0}">0</span> đánh giá)</span>
                                </div>
                                <p class="tl-card-desc" th:text="${tool.description}">Mô tả tool...</p>
                                <div class="tl-card-stock">Tồn kho: <strong th:text="${tool.availableQuantity != null ? tool.availableQuantity : 0}">0</strong> / <span th:text="${tool.quantity}">0</span></div>
                            </div>

                            <div class="tl-card-footer">
                                <a th:href="@{'/tools/detail/' + ${tool.toolId}}" class="tl-btn tl-btn-outline tl-btn-sm">Xem chi tiết</a>
                                <a th:if="${tool.seller.accountId != currentUserId and tool.availableQuantity != null and tool.availableQuantity > 0}"
                                   th:href="@{'/tools/detail/' + ${tool.toolId}}" class="tl-btn tl-btn-outline tl-btn-sm"
                                   sec:authorize="hasRole('CUSTOMER')">Thêm vào giỏ hàng</a>
                                <button th:if="${tool.availableQuantity == 0}" class="tl-btn tl-btn-outline tl-btn-sm" style="opacity:0.55;cursor:not-allowed" disabled>Hết hàng</button>
                                <div class="tl-card-actions" sec:authorize="hasRole('SELLER')">
                                    <form th:if="${tool.status.name() == 'PUBLISHED' or tool.status.name() == 'DEACTIVATED'}"
                                          th:action="@{'/toollist/toggle/' + ${tool.toolId}}" method="post" class="tl-inline-form">
                                        <button type="submit" class="tl-btn-status"
                                                th:classappend="' status-' + ${tool.status.name().toLowerCase()}"
                                                th:text="${tool.status.name()}"></button>
                                    </form>
                                    <button th:if="${tool.status.name() != 'PUBLISHED' and tool.status.name() != 'DEACTIVATED'}"
                                            class="tl-btn-status" th:classappend="' status-' + ${tool.status.name().toLowerCase()}" disabled th:text="${tool.status.name()}"></button>
                                    <a th:if="${tool.status.name() != 'PUBLISHED'}" th:href="@{'/tools/seller/edit/' + ${tool.toolId}}" class="tl-btn tl-btn-success tl-btn-sm">Sửa</a>
                                </div>
                            </div>
                        </article>
                    </div>

                    <!-- PAGINATION -->
                    <div class="pagination" th:if="${totalPages >= 1}">
                        <a th:if="${currentPage > 1}" th:href="@{'/toollist?page=' + (${currentPage - 1}) + '&keyword=' + ${keyword} + '&categoryId=' + ${categoryId} + '&loginMethod=' + ${loginMethod} + '&status=' + ${status} + '&author=' + ${author} + '&priceMin=' + ${priceMin} + '&priceMax=' + ${priceMax} + '&sort=' + ${sort}}">&laquo;</a>
                        <span th:each="i : ${#numbers.sequence(1, totalPages)}">
                            <a th:href="@{'/toollist?page=' + ${i} + '&keyword=' + ${keyword} + '&categoryId=' + ${categoryId} + '&loginMethod=' + ${loginMethod} + '&status=' + ${status} + '&author=' + ${author} + '&priceMin=' + ${priceMin} + '&priceMax=' + ${priceMax} + '&sort=' + ${sort}}"
                               th:text="${i}" th:classappend="${i == currentPage} ? 'active'"></a>
                        </span>
                        <a th:if="${currentPage < totalPages}" th:href="@{'/toollist?page=' + (${currentPage + 1}) + '&keyword=' + ${keyword} + '&categoryId=' + ${categoryId} + '&loginMethod=' + ${loginMethod} + '&status=' + ${status} + '&author=' + ${author} + '&priceMin=' + ${priceMin} + '&priceMax=' + ${priceMax} + '&sort=' + ${sort}}">&raquo;</a>
                    </div>

                </section>

            </section>
        </main>
        </th:block>
    </div>

<!-- Non-seller: render header then the content fragment once -->
<div th:if="${account == null or account.role.roleName.name() != 'SELLER'}"
     th:fragment="content">
    <div th:if="${account.role.roleName.name() == 'CUSTOMER'} || ${account.role.roleName.name() == 'GUEST'}"
         th:replace="common/header :: header"></div>
    <main class="tl-page">

        <!-- PAGE HEADER -->
        <section class="tl-page-header">
            <h1>Danh sách Tool</h1>
            <p>Khám phá các tool đã được đăng, hoặc quản lý tool của bạn (nếu là Seller).</p>
        </section>

        <section class="tl-layout">

            <!-- FILTER HORIZONTAL -->
            <form th:action="@{/toollist}" method="get"
                  class="tl-filter-bar d-flex flex-wrap align-items-center justify-content-start gap-3 mb-3">
                <!-- KEYWORDS -->
                <div class="tl-filter-group tl-filter-inline">
                    <label for="keyword-customer">Từ khóa:</label>
                    <input id="keyword-customer" type="text" name="keyword" placeholder="Tên / mô tả" th:value="${keyword}" />
                </div>

                <!-- CATEGORY -->
                <div class="tl-filter-group tl-filter-inline">
                    <label for="categoryId-customer">Danh mục:</label>
                    <select id="categoryId-customer" name="categoryId">
                        <option value="">Tất cả</option>
                        <option th:each="c : ${categories}" th:value="${c.categoryId}" th:text="${c.categoryName}"
                                th:selected="${categoryId != null and categoryId == c.categoryId}"></option>
                    </select>
                </div>

                <!-- STATUS (SELLER) -->
                <div class="tl-filter-group tl-filter-inline" th:if="${isSeller}">
                    <label for="status-customer">Trạng thái:</label>
                    <select id="status-customer" name="status">
                        <option value="" th:selected="${status == null or status == ''}">Tất cả</option>
                        <option value="PENDING" th:selected="${status == 'PENDING'}">PENDING</option>
                        <option value="APPROVED" th:selected="${status == 'APPROVED'}">APPROVED</option>
                        <option value="REJECTED" th:selected="${status == 'REJECTED'}">REJECTED</option>
                        <option value="PUBLISHED" th:selected="${status == 'PUBLISHED'}">PUBLISHED</option>
                        <option value="DEACTIVATED" th:selected="${status == 'DEACTIVATED'}">DEACTIVATED</option>
                    </select>
                </div>

                <!-- AUTHOR (USER) -->
                <div class="tl-filter-group tl-filter-inline" th:if="${!isSeller}">
                    <label for="author-customer">Author:</label>
                    <select id="author-customer" name="author">
                        <option value="" th:selected="${author == null}">Tất cả</option>
                        <option th:each="s : ${sellers}" th:value="${s.accountId}" th:text="${s.fullName}"
                                th:selected="${author != null and author == s.accountId}"></option>
                    </select>
                </div>

                <!-- LOGIN METHOD -->
                <div class="tl-filter-group tl-filter-inline">
                    <label for="loginMethod-customer">Đăng nhập:</label>
                    <select id="loginMethod-customer" name="loginMethod">
                        <option value="" th:selected="${loginMethod == null or loginMethod == ''}">Tất cả</option>
                        <option value="USER_PASSWORD" th:selected="${loginMethod == 'USER_PASSWORD'}">USER_PASSWORD</option>
                        <option value="TOKEN" th:selected="${loginMethod == 'TOKEN'}">TOKEN</option>
                    </select>
                </div>

                <!-- PRICE RANGE -->
                <div class="tl-filter-group tl-filter-inline">
                    <label>Giá:</label>
                    <input type="number" name="priceMin" placeholder="Từ" th:value="${priceMin}" />
                    <span>-</span>
                    <input type="number" name="priceMax" placeholder="Đến" th:value="${priceMax}" />
                </div>

                <!-- SORT -->
                <div class="tl-filter-group tl-filter-inline">
                    <label for="sort-customer">Sắp xếp:</label>
                    <select id="sort-customer" name="sort">
                        <option value="" th:selected="${sort == null or sort == ''}">Mặc định</option>
                        <option value="date_desc" th:selected="${sort == 'date_desc'}">Ngày mới nhất</option>
                        <option value="date_asc" th:selected="${sort == 'date_asc'}">Ngày cũ nhất</option>
                        <option value="price_asc" th:selected="${sort == 'price_asc'}">Giá tăng</option>
                        <option value="price_desc" th:selected="${sort == 'price_desc'}">Giá giảm</option>
                    </select>
                </div>

                <!-- BUTTONS -->
                <div class="tl-filter-group tl-filter-buttons tl-filter-inline">
                    <button type="submit" class="tl-btn tl-btn-primary">Áp dụng</button>
                    <a th:href="@{/toollist}" class="tl-btn tl-btn-secondary">Xóa lọc</a>
                </div>
            </form>

            <!-- TOOL GRID CONTENT -->
            <section class="tl-content">

                <!-- TOP BAR -->
                <div class="tl-top-bar">
                    <div class="tl-top-right"
                         th:if="${account != null and account.role.roleName.name() == 'SELLER'}">
                        <a th:href="@{/tools/seller/add}" class="tl-btn tl-btn-primary">+ Thêm Tool</a>
                    </div>
                </div>

                <!-- GRID TOOL -->
                <div class="tl-grid" th:if="${tools != null and !#lists.isEmpty(tools)}">
                    <article class="tl-card" th:each="tool : ${tools}" th:if="${isSeller or tool.status.name() == 'PUBLISHED'}">
                        <div class="tl-card-image-wrapper">
                            <img th:src="@{${tool.image}}" alt="Tool image" class="tl-card-image" />
                            <div class="tl-sold-out-overlay" th:if="${tool.availableQuantity != null and tool.availableQuantity == 0}">HẾT HÀNG</div>
                            <span class="tl-badge" th:switch="${tool.status}">
                                <span th:case="'PUBLISHED'" class="tl-badge tl-badge-published">[[${tool.status}]]</span>
                                <span th:case="'PENDING'" class="tl-badge tl-badge-pending">[[${tool.status}]]</span>
                                <span th:case="'REJECTED'" class="tl-badge tl-badge-rejected">[[${tool.status}]]</span>
                                <span th:case="'DEACTIVATED'" class="tl-badge tl-badge-deactivated">[[${tool.status}]]</span>
                            </span>
                        </div>

                        <div class="tl-card-body">
                            <h3 class="tl-card-title" th:text="${tool.toolName}">Tên tool</h3>
                            <p class="tl-card-category" th:if="${tool.category != null}">Danh mục: <span th:text="${tool.category.categoryName}">Category</span></p>
                            <p class="tl-card-seller" th:if="${tool.seller != null}">Seller: <span th:text="${tool.seller.fullName}" class="tl-card-seller-name">Seller Name</span></p>
                            <p class="tl-card-price">
                                Giá:
                                <span th:if="${tool.minPrice != null and tool.maxPrice != null and tool.minPrice.compareTo(tool.maxPrice) == 0}">
                                    <strong th:text="${#numbers.formatDecimal(tool.minPrice, 0, 'COMMA', 0, 'POINT')}">0</strong> đ
                                </span>
                                <span th:if="${tool.minPrice != null and tool.maxPrice != null and tool.minPrice.compareTo(tool.maxPrice) != 0}">
                                    <strong th:text="${#numbers.formatDecimal(tool.minPrice, 0, 'COMMA', 0, 'POINT')}">0</strong> -
                                    <strong th:text="${#numbers.formatDecimal(tool.maxPrice, 0, 'COMMA', 0, 'POINT')}">0</strong> đ
                                </span>
                                <span th:if="${tool.minPrice == null}"><strong>Liên hệ</strong></span>
                            </p>
                            <div class="tl-card-licenses" th:if="${tool.licenses != null and !#lists.isEmpty(tool.licenses)}">
                                <p class="tl-card-license-title mb-1">License:</p>
                                <ul class="tl-license-list">
                                    <li th:each="lic : ${tool.licenses}">Gói <span th:text="${lic.durationDays}">0</span> ngày - <span th:text="${#numbers.formatDecimal(lic.price, 0, 'COMMA', 0, 'POINT')}">0</span> đ</li>
                                </ul>
                            </div>
                            <div class="tl-card-rating">
                                <span class="tl-stars">★</span>
                                <span class="tl-rating-value" th:text="${tool.averageRating != null ? #numbers.formatDecimal(tool.averageRating,1,1) : '0.0'}">0.0</span>
                                <span class="tl-rating-count">(<span th:text="${tool.totalReviews != null ? tool.totalReviews : 0}">0</span> đánh giá)</span>
                            </div>
                            <p class="tl-card-desc" th:text="${tool.description}">Mô tả tool...</p>
                            <div class="tl-card-stock">Tồn kho: <strong th:text="${tool.availableQuantity != null ? tool.availableQuantity : 0}">0</strong> / <span th:text="${tool.quantity}">0</span></div>
                        </div>

                        <div class="tl-card-footer">
                            <a th:href="@{'/tools/detail/' + ${tool.toolId}}" class="tl-btn tl-btn-outline tl-btn-sm">Xem chi tiết</a>
                            <a th:if="${tool.seller.accountId != currentUserId and tool.availableQuantity != null and tool.availableQuantity > 0}"
                               th:href="@{'/tools/detail/' + ${tool.toolId}}" class="tl-btn tl-btn-outline tl-btn-sm"
                               sec:authorize="hasRole('CUSTOMER')">Thêm vào giỏ hàng</a>
                            <button th:if="${tool.availableQuantity == 0}" class="tl-btn tl-btn-outline tl-btn-sm" style="opacity:0.55;cursor:not-allowed" disabled>Hết hàng</button>
                            <div class="tl-card-actions" sec:authorize="hasRole('SELLER')">
                                <form th:if="${tool.status.name() == 'PUBLISHED' or tool.status.name() == 'DEACTIVATED'}"
                                      th:action="@{'/toollist/toggle/' + ${tool.toolId}}" method="post" class="tl-inline-form">
                                    <button type="submit" class="tl-btn-status"
                                            th:classappend="' status-' + ${tool.status.name().toLowerCase()}"
                                            th:text="${tool.status.name()}"></button>
                                </form>
                                <button th:if="${tool.status.name() != 'PUBLISHED' and tool.status.name() != 'DEACTIVATED'}"
                                        class="tl-btn-status" th:classappend="' status-' + ${tool.status.name().toLowerCase()}" disabled th:text="${tool.status.name()}"></button>
                                <a th:if="${tool.status.name() != 'PUBLISHED'}" th:href="@{'/tools/seller/edit/' + ${tool.toolId}}" class="tl-btn tl-btn-success tl-btn-sm">Sửa</a>
                            </div>
                        </div>
                    </article>
                </div>

            </section>

        </section>
    </main>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
