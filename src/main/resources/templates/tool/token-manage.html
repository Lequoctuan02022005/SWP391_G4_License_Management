<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Token Management | Tool Market</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">
</head>

<body>

<div th:replace="common/sidebar-header :: role-sidebar">
    <th:block th:fragment="content">

        <div class="container-fluid px-4 py-4">
            <div class="card shadow-sm">

                <!-- HEADER -->
                <div class="card-header bg-white">
                    <h5 class="fw-bold mb-0">Token Management</h5>
                </div>

                <!-- INFO -->
                <div class="card-body border-bottom">
                    <div class="alert alert-info mb-0"
                         th:text="${isEdit}
                         ? 'You can add or remove tokens. Quantity will be updated automatically.'
                         : 'You can change tokens before finalizing your tool.'">
                    </div>
                </div>

                <div class="card-body">

                    <!-- ================= CREATE ================= -->
                    <form method="post"
                          th:if="${!isEdit}"
                          th:action="@{/tools/token/manage/submit}">

                        <div class="token-list">
                            <div class="row mb-2 align-items-center"
                                 th:each="t : ${tokens}">

                                <div class="col-8">
                                    <input type="text"
                                           class="form-control token-field"
                                           name="tokens"
                                           th:value="${t}"
                                           readonly
                                           pattern="[0-9]{6}"
                                           maxlength="6"
                                           required>
                                </div>

                                <div class="col-2">
                                    <button type="button"
                                            class="btn btn-outline-primary w-100"
                                            onclick="changeToken(this)">
                                        Change
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="submit"
                                    formaction="/tools/token/manage/back"
                                    formmethod="post"
                                    class="btn btn-secondary">
                                ← Back
                            </button>

                            <button type="submit" class="btn btn-success">
                                Finalize Tool
                            </button>
                        </div>
                    </form>

                    <!-- ================= EDIT ================= -->
                    <form method="post"
                          th:if="${isEdit}"
                          th:action="@{/tools/token/edit/finalize}">

                        <div class="token-list">
                            <div class="row mb-2 align-items-center"
                                 th:each="t : ${tokens}">

                                <div class="col-8">
                                    <input type="text"
                                           class="form-control token-field"
                                           name="tokens"
                                           th:value="${t}"
                                           pattern="[0-9]{6}"
                                           maxlength="6"
                                           required>
                                </div>

                                <div class="col-2">
                                    <button type="button"
                                            class="btn btn-outline-primary w-100"
                                            onclick="changeToken(this)">
                                        Change
                                    </button>
                                </div>

                                <div class="col-2">
                                    <button type="button"
                                            class="btn btn-outline-danger w-100"
                                            onclick="removeToken(this)">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <button type="button"
                                    class="btn btn-outline-primary"
                                    onclick="addToken()">
                                + Add Token
                            </button>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="submit"
                                    formaction="/tools/token/edit/back"
                                    formmethod="post"
                                    class="btn btn-secondary">
                                ← Back
                            </button>

                            <button type="submit" class="btn btn-success">
                                Finalize Tool
                            </button>
                        </div>
                    </form>

                </div>
            </div>
        </div>

    </th:block>
</div>

<!-- JS (TỐI GIẢN) -->
<script>
    function randomToken() {
        return String(Math.floor(Math.random() * 1000000)).padStart(6, '0');
    }

    function changeToken(btn) {
        const input = btn.closest(".row").querySelector(".token-field");
        input.value = randomToken();
    }

    function addToken() {
        const list = document.querySelector(".token-list");

        const row = document.createElement("div");
        row.className = "row mb-2 align-items-center";

        row.innerHTML = `
            <div class="col-8">
                <input type="text"
                       class="form-control token-field"
                       name="tokens"
                       pattern="[0-9]{6}"
                       maxlength="6"
                       required>
            </div>
            <div class="col-2">
                <button type="button"
                        class="btn btn-outline-primary w-100"
                        onclick="changeToken(this)">
                    Change
                </button>
            </div>
            <div class="col-2">
                <button type="button"
                        class="btn btn-outline-danger w-100"
                        onclick="removeToken(this)">
                    Remove
                </button>
            </div>
        `;
        list.appendChild(row);
    }

    function removeToken(btn) {
        btn.closest(".row").remove();
    }
</script>

</body>
</html>
