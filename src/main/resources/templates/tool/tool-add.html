<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Add Tool | Tool Market</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>
    .preview-box {
        width: 100%;
        height: 100%;
        min-height: 320px;

        border: 2px dashed #bbb;
        border-radius: 12px;
        background: #fafafa;

        display: flex;
        align-items: center;
        justify-content: center;

        overflow: hidden;
    }

    .preview-box img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* KHÔNG cover */
    }

</style>
<body>
<div th:if="${error}" class="alert alert-danger">
    <span th:text="${error}"></span>
</div>
<div th:replace="common/sidebar-header :: role-sidebar">
    <th:block th:fragment="content">

        <div class="container-fluid px-4 py-4">

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="fw-bold mb-0">Add New Tool</h2>
                <a href="/toollist" class="btn btn-outline-secondary">← Back to List</a>
            </div>

            <!-- FORM -->
            <form method="post"
                  enctype="multipart/form-data"
                  th:action="@{/tools/seller/add}"
                  th:object="${tool}"
                  class="bg-white p-4 shadow-sm rounded">

                <!-- GLOBAL ERRORS -->
                <div class="alert alert-danger"
                     th:if="${#fields.hasGlobalErrors()}">
                    <ul class="mb-0">
                        <li th:each="err : ${#fields.globalErrors()}"
                            th:text="${err}"></li>
                    </ul>
                </div>

                <div class="row g-4 align-items-stretch tool-wrapper">

                    <!-- LEFT IMAGE PREVIEW -->
                    <div class="col-md-5 d-flex">
                        <div id="previewBox" class="preview-box">
                            <img th:if="${tool.image != null}"
                                 th:src="${tool.image}">
                        </div>
                    </div>

                    <!-- RIGHT FORM -->
                    <div class="col-md-7 full-height">

                        <!-- Tool Name -->
                        <div class="mb-3">
                            <label class="fw-bold">Tool Name</label>
                            <input type="text" class="form-control"
                                   th:field="*{toolName}"
                                   th:classappend="${#fields.hasErrors('toolName')} ? 'is-invalid'">
                            <div class="invalid-feedback"
                                 th:errors="*{toolName}"></div>
                        </div>

                        <!-- Upload Image -->
                        <div class="mb-3">
                            <label class="fw-bold">Upload Image</label>
                            <input type="file" class="form-control"
                                   name="imageFile"
                                   accept="image/*"
                                   onchange="loadImage(event)"
                                   th:attr="required=${tool.toolId == null}">
                        </div>

                        <!-- Upload Tool -->
                        <div class="mb-3">
                            <label class="fw-bold">Upload Tool File</label>
                            <input type="file" class="form-control"
                                   name="toolFile"
                                   th:attr="required=${tool.toolId == null}">
                        </div>

                        <!-- Category -->
                        <div class="mb-3">
                            <label class="fw-bold">Category</label>
                            <select class="form-select"
                                    th:field="*{category.categoryId}"
                                    th:classappend="${#fields.hasErrors('category')} ? 'is-invalid'">
                                <option value="">-- Select category --</option>
                                <option th:each="c : ${categories}"
                                        th:value="${c.categoryId}"
                                        th:text="${c.categoryName}">
                                </option>
                            </select>
                            <div class="invalid-feedback"
                                 th:errors="*{category}"></div>
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label class="fw-bold">Description</label>
                            <textarea class="form-control"
                                      rows="3"
                                      th:field="*{description}"
                                      th:classappend="${#fields.hasErrors('description')} ? 'is-invalid'"></textarea>
                            <div class="invalid-feedback"
                                 th:errors="*{description}"></div>
                        </div>

                        <!-- Login Method -->
                        <div class="mb-3">
                            <label class="fw-bold">Login Method</label>
                            <select class="form-select"
                                    th:field="*{loginMethod}"
                                    th:classappend="${#fields.hasErrors('loginMethod')} ? 'is-invalid'">
                                <option value="">-- Select --</option>
                                <option value="USER_PASSWORD">Username + Password</option>
                                <option value="TOKEN">Token</option>
                            </select>
                            <div class="invalid-feedback"
                                 th:errors="*{loginMethod}"></div>
                        </div>

                        <!-- Quantity -->
                        <div class="mb-3">
                            <label class="fw-bold">Quantity</label>
                            <input type="number" class="form-control"
                                   th:field="*{quantity}"
                                   min="1"
                                   th:classappend="${#fields.hasErrors('quantity')} ? 'is-invalid'">
                            <div class="invalid-feedback"
                                 th:errors="*{quantity}"></div>
                        </div>

                        <!-- LICENSE -->
                        <div class="mb-3">
                            <label class="fw-bold">License Packages</label>

                            <div id="licenseGroup">

                                <!-- RESTORE FROM SESSION -->
                                <div th:if="${licenses != null}">
                                    <div class="row mb-2 license-row"
                                         th:each="lic : ${licenses}">
                                        <div class="col-5">
                                            <input type="number"
                                                   name="licenseDays"
                                                   class="form-control"
                                                   min="1"
                                                   th:value="${lic.durationDays}"
                                                   required>
                                        </div>
                                        <div class="col-5">
                                            <input type="number"
                                                   name="licensePrices"
                                                   class="form-control"
                                                   min="0"
                                                   max="100000000"
                                                   th:value="${lic.price}"
                                                   required>
                                        </div>
                                        <div class="col-2 d-flex align-items-center">
                    <span class="remove-license"
                          onclick="removeLicense(this)">×</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- CREATE NEW -->
                                <div th:if="${licenses == null}">
                                    <div class="row mb-2 license-row">
                                        <div class="col-5">
                                            <input type="number"
                                                   name="licenseDays"
                                                   class="form-control"
                                                   min="1"
                                                   required>
                                        </div>
                                        <div class="col-5">
                                            <input type="number"
                                                   name="licensePrices"
                                                   class="form-control"
                                                   min="0"
                                                   max="100000000"
                                                   required>
                                        </div>
                                        <div class="col-2 d-flex align-items-center">
                    <span class="remove-license"
                          onclick="removeLicense(this)">×</span>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <button type="button"
                                    onclick="addLicense()"
                                    class="btn btn-outline-primary btn-sm">
                                + Add Package
                            </button>
                        </div>

                        <button type="submit" class="btn btn-success px-4">Save Tool</button>
                        <a href="/tools/seller/add?cancel=true"
                           class="btn btn-secondary px-4">Clear</a>

                    </div>
                </div>
            </form>
        </div>

        <script>
            document.querySelector("form").addEventListener("submit", function (e) {
                const img = document.querySelector("input[name='imageFile']").files[0];
                if (img && img.size > 5 * 1024 * 1024) {
                    e.preventDefault();
                    alert("Image must be 5MB or less.");
                }
            });
            function loadImage(e) {
                const box = document.getElementById("previewBox");
                box.innerHTML = "";
                const img = document.createElement("img");
                img.src = URL.createObjectURL(e.target.files[0]);
                box.appendChild(img);
            }

            function addLicense() {
                const g = document.getElementById("licenseGroup");
                g.insertAdjacentHTML("beforeend", `
            <div class="row mb-2 license-row">
                <div class="col-5">
                    <input type="number"
                           name="licenseDays"
                           class="form-control"
                           min="1"
                           required>
                </div>
                <div class="col-5">
                    <input type="number"
                           name="licensePrices"
                           class="form-control"
                           min="0"
                           max="100000000"
                           required>
                </div>
                <div class="col-2 d-flex align-items-center">
                    <span class="remove-license"
                          onclick="removeLicense(this)">×</span>
                </div>
            </div>
        `);
            }

            function removeLicense(el) {
                const rows = document.querySelectorAll(".license-row");
                if (rows.length <= 1) {
                    alert("Tool must have at least one license package.");
                    return;
                }
                el.closest(".license-row").remove();
            }
        </script>


    </th:block>
</div>

</body>
</html>
