<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Edit Tool | Tool Market</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/tool-form.css">
    <link th:href="@{/css/home.css}" rel="stylesheet">
</head>

<body>

<!-- HEADER -->
<!--<div th:insert="common/header :: header"></div>-->

<div class="container mt-4">

    <h2 class="fw-bold mb-4">Edit Tool</h2>

    <form th:action="@{/tools/seller/edit/{id}(id=${tool.toolId})}"
          method="post"
          enctype="multipart/form-data"
          class="bg-white p-4 shadow-sm rounded">

        <!-- HIDDEN FIELDS (bắt buộc tránh null) -->
        <input type="hidden" name="loginMethod" th:value="${tool.loginMethod.name()}">
        <input type="hidden" name="quantity" th:value="${tool.quantity}">
        <input type="hidden" name="note" th:value="${tool.note}">
        <input type="hidden" name="description" th:value="${tool.description}">
        <input type="hidden" name="category.categoryId" th:value="${tool.category.categoryId}">

        <div class="row g-4 align-items-stretch tool-wrapper">

            <!-- LEFT IMAGE -->
            <div class="col-md-5 d-flex full-height">
                <div id="previewBox" class="preview-box">
                    <img th:if="${tool.image != null}"
                         th:src="@{'/' + ${tool.image}}"
                         id="oldPreview"
                         style="width:100%; height:100%; object-fit:contain;">
                </div>
            </div>

            <!-- RIGHT FORM -->
            <div class="col-md-7 full-height">

                <!-- Tool Name -->
                <div class="mb-3">
                    <label class="fw-bold">Tool Name</label>
                    <input type="text" class="form-control" name="toolName"
                           th:value="${tool.toolName}" required>
                </div>

                <!-- Upload New Image -->
                <div class="mb-3">
                    <label class="fw-bold">Upload New Image</label>
                    <input type="file" class="form-control" name="imageFile"
                           accept="image/*" onchange="loadImage(event)">
                </div>

                <!-- Upload New Tool File -->
                <div class="mb-3">
                    <label class="fw-bold">Upload New Tool File</label>
                    <input type="file" class="form-control" name="toolFile">
                </div>

                <!-- Category -->
                <div class="mb-3">
                    <label class="fw-bold">Category</label>
                    <select name="category.categoryId" class="form-select" required>
                        <option th:each="c : ${categories}"
                                th:value="${c.categoryId}"
                                th:text="${c.categoryName}"
                                th:selected="${tool.category.categoryId == c.categoryId}">
                        </option>
                    </select>
                </div>

                <!-- Description (edit được nếu USER_PASSWORD) -->
                <div class="mb-3" th:if="${tool.loginMethod.name() == 'USER_PASSWORD'}">
                    <label class="fw-bold">Description</label>
                    <textarea class="form-control" name="description" rows="3" required
                              th:text="${tool.description}"></textarea>
                </div>

                <!-- Description readonly nếu TOKEN -->
                <div class="mb-3" th:if="${tool.loginMethod.name() == 'TOKEN'}">
                    <label class="fw-bold">Description</label>
                    <textarea class="form-control" rows="3" disabled
                              th:text="${tool.description}"></textarea>
                </div>

                <!-- Login Method -->
                <div class="mb-3">
                    <label class="fw-bold">Login Method</label>
                    <input class="form-control" th:value="${tool.loginMethod.name()}" disabled>
                </div>

                <!-- Quantity -->
                <div class="mb-3" th:if="${tool.loginMethod.name() == 'USER_PASSWORD'}">
                    <label class="fw-bold">Quantity</label>
                    <input type="number" class="form-control"
                           name="quantity" th:value="${tool.quantity}" required>
                </div>

                <div class="mb-3" th:if="${tool.loginMethod.name() == 'TOKEN'}">
                    <label class="fw-bold">Quantity</label>
                    <input type="number" class="form-control" th:value="${tool.quantity}" disabled>
                </div>

                <!-- License Packages -->
                <div class="mb-3" th:if="${tool.loginMethod.name() == 'USER_PASSWORD'}">
                    <label class="fw-bold">License Packages</label>
                    <div id="licenseGroup">
                        <div th:each="l : ${tool.licenses}" class="row mb-2 license-row">
                            <div class="col-5">
                                <input type="number" name="licenseDays"
                                       th:value="${l.durationDays}" class="form-control" required>
                            </div>
                            <div class="col-5">
                                <input type="number" name="licensePrices"
                                       th:value="${l.price}" class="form-control" required>
                            </div>
                            <div class="col-2 d-flex align-items-center">
                                <span class="remove-license" onclick="removeLicense(this)">×</span>
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="addLicense()"
                            class="btn btn-outline-primary btn-sm">+ Add Package</button>
                </div>

                <!-- BUTTON -->
                <div class="mt-4">

                    <!-- USER_PASSWORD -->
                    <button th:if="${tool.loginMethod.name() == 'USER_PASSWORD'}"
                            class="btn btn-success px-4">
                        Save Changes
                    </button>

                    <!-- TOKEN → nhảy vào edit token -->
                    <button th:if="${tool.loginMethod.name() == 'TOKEN'}"
                            type="submit"
                            name="action"
                            value="token"
                            class="btn btn-primary px-4">
                        Manage Tokens
                    </button>

                    <a href="/toollist" class="btn btn-outline-secondary px-4">Cancel</a>

                </div>
            </div>
        </div>
    </form>
</div>

<!-- JS PREVIEW + LICENSE SCRIPT -->
<script>
    function loadImage(event) {
        let preview = document.getElementById("previewBox");
        preview.innerHTML = "";

        let img = document.createElement("img");
        img.src = URL.createObjectURL(event.target.files[0]);
        img.style.width = "100%";
        img.style.height = "100%";
        img.style.objectFit = "contain";

        preview.appendChild(img);
    }

    function addLicense() {
        let group = document.getElementById("licenseGroup");

        let div = document.createElement("div");
        div.classList.add("row", "mb-2", "license-row");

        div.innerHTML = `
            <div class="col-5">
                <input type="number" name="licenseDays" class="form-control" placeholder="Days" required>
            </div>
            <div class="col-5">
                <input type="number" name="licensePrices" class="form-control" placeholder="Price (VND)" required>
            </div>
            <div class="col-2 d-flex align-items-center">
                <span class="remove-license" onclick="removeLicense(this)">×</span>
            </div>
        `;
        group.appendChild(div);
    }

    function removeLicense(el) {
        el.parentElement.parentElement.remove();
    }
</script>

</body>
</html>
