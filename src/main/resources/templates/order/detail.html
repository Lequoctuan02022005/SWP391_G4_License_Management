<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Chi ti·∫øt ƒë∆°n h√†ng</title>

    <link rel="stylesheet" th:href="@{/css/style.css}" />

    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#f6f7fb; color:#111; }
        .container { max-width: 980px; margin: 24px auto; padding: 0 16px; }
        .card { background:#fff; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,.06); padding: 16px; }
        .top { display:flex; align-items:center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
        h1 { margin: 0; font-size: 22px; }

        .btn { display:inline-block; padding: 10px 14px; border-radius: 10px; text-decoration:none; font-weight: 800; border: 1px solid transparent; cursor:pointer; }
        .btn-ghost { background:#eef2ff; color:#1f3a8a; }
        .btn-danger { background:#fff1f2; color:#9f1239; border-color:#fecdd3; }
        .btn-dark { background:#111827; color:#fff; }
        .btn-disabled { opacity:.5; pointer-events:none; }

        .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 14px; }
        .box { border: 1px solid #edf0f5; border-radius: 12px; padding: 12px; background:#fbfcff; }
        .label { font-size: 12px; color:#555; text-transform: uppercase; letter-spacing: .04em; margin-bottom: 6px; }
        .value { font-size: 14px; }
        .value b { font-size: 16px; }

        .badge { display:inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 900; }
        .b-pending { background:#fff7ed; color:#9a3412; }
        .b-success { background:#ecfdf5; color:#065f46; }
        .b-failed { background:#fef2f2; color:#991b1b; }
        .b-null { background:#f3f4f6; color:#374151; }

        .muted { color:#666; font-size: 13px; }
        .full { grid-column: 1 / -1; }
        .sep { height: 1px; background:#edf0f5; margin: 12px 0; }

        .tool-wrap { display:flex; gap: 14px; align-items:flex-start; }
        .tool-img { width: 140px; height: 90px; object-fit: cover; border-radius: 10px; border:1px solid #e5e7eb; background:#fff; }
        .actions { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
        .stars { font-size: 18px; letter-spacing: 1px; }

        .alert { padding: 10px 12px; border-radius: 10px; margin: 12px 0; font-weight: 700; }
        .alert-success { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
        .alert-danger { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }

        .pwd-wrap { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px; }
        .pwd-input { padding:10px; border:1px solid #d7d9e0; border-radius:10px; background:#fff; min-width: 240px; }
        .btn-eye { border:0; background:#f3f4f6; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:900; }

        @media (max-width: 820px) {
            .grid { grid-template-columns: 1fr; }
            .tool-wrap{flex-direction:column;}
            .tool-img{width:100%; height:180px;}
            .pwd-input{min-width: 100%;}
        }
    </style>
</head>

<body>
<div class="container">
    <div class="card">

        <div class="top">
            <h1>Chi ti·∫øt ƒë∆°n h√†ng #<span th:text="${order.orderId}">0</span></h1>
            <a class="btn btn-ghost" th:href="@{/customer/orders}">‚Üê Quay l·∫°i danh s√°ch</a>
        </div>

        <!-- flash msg -->
        <div th:if="${successMsg != null and !#strings.isEmpty(successMsg)}"
             class="alert alert-success" th:text="${successMsg}"></div>
        <div th:if="${errorMsg != null and !#strings.isEmpty(errorMsg)}"
             class="alert alert-danger" th:text="${errorMsg}"></div>

        <p class="muted">
            M√£ ƒë∆°n: <b th:text="${order.orderId}">0</b>
            <span th:if="${order.createdAt != null}">
        ‚Ä¢ Ng√†y mua: <b th:text="${#temporals.format(order.createdAt,'dd/MM/yyyy HH:mm')}">--</b>
      </span>
            <span th:if="${order.account != null and order.account.fullName != null}">
        ‚Ä¢ Ng∆∞·ªùi mua: <b th:text="${order.account.fullName}">--</b>
      </span>
        </p>

        <!-- ========= FLAGS: ƒë·ªÉ tr√°nh hi·ªán 2 n√∫t ========= -->
        <th:block
                th:with="
        isSuccess=${order.orderStatus != null and #strings.equalsIgnoreCase(order.orderStatus.toString(),'SUCCESS')},
        hasLA=${order.licenseAccount != null},
        laActive=${order.licenseAccount != null and order.licenseAccount.status != null and #strings.equalsIgnoreCase(order.licenseAccount.status.toString(),'ACTIVE')},
        laUsed=${order.licenseAccount != null and order.licenseAccount.used != null and order.licenseAccount.used},
        canUse=${isSuccess and hasLA and laActive and !laUsed}
      ">

            <div class="grid">

                <!-- TOOL CARD -->
                <div class="box full" th:if="${order.tool != null}">
                    <div class="label">Th√¥ng tin Tool</div>

                    <div class="tool-wrap">
                        <img class="tool-img"
                             th:src="${order.tool.image}"
                             alt="tool image"
                             onerror="this.style.display='none'"/>

                        <div class="value" style="flex:1;">
                            <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                                <div>
                                    <div><b th:text="${order.tool.toolName}">Tool name</b></div>
                                    <div class="muted" th:if="${order.tool.description != null}">
                                        <span th:text="${order.tool.description}">M√¥ t·∫£</span>
                                    </div>
                                    <div class="muted" th:if="${order.tool.loginMethod != null}">
                                        Login method: <b th:text="${order.tool.loginMethod}">TOKEN</b>
                                    </div>
                                </div>

                                <!-- Rating -->
                                <div style="text-align:right;">
                                    <div class="muted">ƒê√°nh gi√° c·ªßa b·∫°n</div>
                                    <div class="stars" th:if="${myFeedback != null}">
                    <span th:each="i : ${#numbers.sequence(1,5)}"
                          th:text="${i <= myFeedback.rating ? '‚òÖ' : '‚òÜ'}">‚òÖ</span>
                                    </div>
                                    <div class="stars" th:if="${myFeedback == null}">
                                        <span>‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span>
                                    </div>
                                    <div class="muted" th:if="${avgRating != null}">
                                        Trung b√¨nh: <b th:text="${#numbers.formatDecimal(avgRating,1,'POINT',1,'POINT')}">0.0</b>/5
                                    </div>
                                </div>
                            </div>

<<<<<<< HEAD
                            <!-- Rating -->
<!--                            <div style="text-align:right;" th:with="myR=${myFeedback != null ? myFeedback.rating : 0}">-->
<!--                                <div class="muted">ƒê√°nh gi√° c·ªßa b·∫°n</div>-->
<!--                                <div class="stars">-->
<!--                                    <span th:each="i : ${#numbers.sequence(1,5)}"-->
<!--                                          th:text="${i <= myR ? '‚òÖ' : '‚òÜ'}">‚òÖ</span>-->
<!--                                </div>-->
<!--                                <div class="muted" th:if="${avgRating != null}">-->
<!--                                    Trung b√¨nh: <b th:text="${#numbers.formatDecimal(avgRating,1,'POINT',1,'POINT')}">0.0</b>/5-->
<!--                                </div>-->
<!--                            </div>-->
=======
                            <!-- ACTIONS -->
                            <div class="actions">

                                <!-- ‚úÖ CH·ªà HI·ªÜN 1 N√öT ‚ÄúD√πng d·ªãch v·ª•‚Äù (form) khi canUse -->
                                <form th:if="${canUse}"
                                      th:action="@{/customer/license-accounts/{id}/use(id=${order.licenseAccount.licenseAccountId})}"
                                      method="post" style="display:inline;"
                                      onsubmit="return confirm('X√°c nh·∫≠n d√πng d·ªãch v·ª• cho License Account n√†y?');">
                                    <input type="hidden" th:if="${_csrf != null}"
                                           th:name="${_csrf.parameterName}"
                                           th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-dark">D√πng d·ªãch v·ª•</button>
                                </form>

                                <!-- ‚ùó N·∫øu kh√¥ng canUse => hi·ªán 1 n√∫t disabled + l√Ω do (switch) -->
                                <th:block th:if="${!canUse}">
                                    <a class="btn btn-disabled"
                                       th:text="${
                       !isSuccess ? 'D√πng d·ªãch v·ª• (ƒê∆°n ch∆∞a SUCCESS)'
                       : (!hasLA ? 'D√πng d·ªãch v·ª• (Ch∆∞a c·∫•p LicenseAccount)'
                       : (!laActive ? 'D√πng d·ªãch v·ª• (LicenseAccount ch∆∞a ACTIVE)'
                       : (laUsed ? 'D√πng d·ªãch v·ª• (ƒê√£ d√πng)' : 'D√πng d·ªãch v·ª• (Kh√¥ng kh·∫£ d·ª•ng)')))
                     }">D√πng d·ªãch v·ª• (Kh√¥ng kh·∫£ d·ª•ng)</a>
                                </th:block>

                                <!-- Chi ti·∫øt LicenseAccount -->
                                <a class="btn"
                                   th:if="${order.licenseAccount != null}"
                                   th:href="@{/customer/license-accounts/{id}(id=${order.licenseAccount.licenseAccountId})}">
                                    Chi ti·∫øt
                                </a>
                                <a class="btn btn-disabled" th:if="${order.licenseAccount == null}">Chi ti·∫øt</a>

                                <!-- Feedback -->
                                <a class="btn btn-ghost"
                                   th:if="${order.orderStatus != null and #strings.equalsIgnoreCase(order.orderStatus.toString(),'SUCCESS') and order.tool != null}"
                                   th:href="@{/customer/feedback/create(orderId=${order.orderId}, toolId=${order.tool.toolId})}">
                                    Feedback
                                </a>

                                <!-- B√°o c√°o -->
                                <a class="btn btn-danger"
                                   th:if="${order.tool != null}"
                                   th:href="@{/customer/tool-report/create(toolId=${order.tool.toolId}, orderId=${order.orderId})}">
                                    B√°o c√°o
                                </a>
                            </div>

                            <div class="muted" th:if="${myFeedback != null and myFeedback.comment != null}">
                                Nh·∫≠n x√©t: <span th:text="${myFeedback.comment}">comment</span>
                            </div>
>>>>>>> 2663297e31c64619f54956de599f54933442ddc8
                        </div>
                    </div>
                </div>

                <!-- ORDER STATUS -->
                <div class="box">
                    <div class="label">Tr·∫°ng th√°i ƒë∆°n</div>
                    <div class="value">
            <span class="badge b-pending"
                  th:if="${order.orderStatus != null and #strings.equalsIgnoreCase(order.orderStatus.toString(),'PENDING')}">PENDING</span>
                        <span class="badge b-success"
                              th:if="${order.orderStatus != null and #strings.equalsIgnoreCase(order.orderStatus.toString(),'SUCCESS')}">SUCCESS</span>
                        <span class="badge b-failed"
                              th:if="${order.orderStatus != null and #strings.equalsIgnoreCase(order.orderStatus.toString(),'FAILED')}">FAILED</span>
                        <span class="badge b-null"
                              th:if="${order.orderStatus == null}">N/A</span>

                        <div class="muted" th:if="${order.lastTxnRef != null}">
                            M√£ giao d·ªãch (lastTxnRef): <b th:text="${order.lastTxnRef}">ref</b>
                        </div>
                    </div>
                </div>

                <!-- PRICE -->
                <div class="box">
                    <div class="label">Thanh to√°n</div>
                    <div class="value">
                        <b th:text="${order.price != null ? (#numbers.formatDecimal(order.price, 0, 'COMMA', 0, 'POINT') + ' VND') : '(N/A)'}">0 VND</b>
                        <div class="muted" th:if="${order.paymentMethod != null}">
                            Payment method: <b th:text="${order.paymentMethod}">BANK</b>
                        </div>
                    </div>
                </div>

                <!-- LICENSE -->
                <div class="box">
                    <div class="label">G√≥i License</div>
                    <div class="value">
                        <div><b th:text="${order.license != null ? order.license.name : '(N/A)'}">License</b></div>
                        <div class="muted" th:if="${order.license != null and order.license.durationDays != null}">
                            Th·ªùi l∆∞·ª£ng g√≥i: <b th:text="${order.license.durationDays}">0</b> ng√†y
                        </div>
                        <div class="muted" th:if="${order.license != null and order.license.price != null}">
                            Gi√° g√≥i:
                            <b th:text="${#numbers.formatDecimal(order.license.price,0,'COMMA',0,'POINT')} + ' VND'">0 VND</b>
                        </div>
                    </div>
                </div>

                <!-- TRANSACTION -->
                <div class="box" th:if="${order.transaction != null}">
                    <div class="label">Transaction</div>
                    <div class="value">
                        <div>Txn ID: <b th:text="${order.transaction.transactionId}">0</b></div>
                        <div class="muted" th:if="${order.transaction.vnpayTxnRef != null}">
                            vnpayTxnRef: <b th:text="${order.transaction.vnpayTxnRef}">ref</b>
                        </div>
                    </div>
                </div>

                <!-- LICENSE ACCOUNT -->
                <div class="box full" th:if="${order.licenseAccount != null}">
                    <div class="label">License Account ƒë∆∞·ª£c c·∫•p</div>
                    <div class="value">
                        <div>ID: <b th:text="${order.licenseAccount.licenseAccountId}">0</b></div>

                        <div class="muted" style="margin-top:8px;">
                            Used: <b th:text="${order.licenseAccount.used}">false</b>
                        </div>

                        <div class="muted" th:if="${order.licenseAccount.status != null}">
                            Status: <b th:text="${order.licenseAccount.status}">ACTIVE</b>
                        </div>

                        <!-- ‚úÖ Username/Password + n√∫t xem/che -->
                        <div class="sep"></div>

                        <div class="muted" th:if="${order.licenseAccount.username != null}">
                            Username: <b th:text="${order.licenseAccount.username}">user</b>
                        </div>

                        <div class="pwd-wrap" th:if="${order.licenseAccount.password != null}">
                            <input class="pwd-input"
                                   th:id="'pwd_' + ${order.licenseAccount.licenseAccountId}"
                                   type="password"
                                   th:value="${order.licenseAccount.password}"
                                   readonly />
                            <button class="btn-eye"
                                    type="button"
                                    th:attr="data-target=${'pwd_' + order.licenseAccount.licenseAccountId}"
                                    onclick="togglePwdByBtn(this)">üëÅ</button>
                            <span class="muted">Xem/Che m·∫≠t kh·∫©u</span>
                        </div>

                        <div class="muted" th:if="${order.licenseAccount.password == null}">
                            Password: <b>(N/A)</b>
                        </div>
                    </div>
                </div>

<<<<<<< HEAD

=======
                <div class="box full" th:if="${order.licenseAccount == null}">
                    <div class="label">License Account ƒë∆∞·ª£c c·∫•p</div>
                    <div class="value">
                        <span class="badge b-null">Ch∆∞a t·∫°o</span>
                        <div class="muted">Ch·ªâ b·∫≠t ‚ÄúD√πng d·ªãch v·ª•‚Äù khi ƒë∆°n SUCCESS v√† ƒë√£ c·∫•p LicenseAccount.</div>
                    </div>
                </div>
>>>>>>> 2663297e31c64619f54956de599f54933442ddc8

            </div>
        </th:block>

    </div>
</div>

<script>
    function togglePwdByBtn(btn){
        const id = btn.getAttribute('data-target');
        const el = document.getElementById(id);
        if(!el) return;
        el.type = (el.type === 'password') ? 'text' : 'password';
    }
</script>

</body>
</html>
