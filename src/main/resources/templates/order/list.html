<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lịch sử đơn hàng</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" th:href="@{/css/orders.css}">
</head>

<body>
<div th:replace="~{common/header :: header}"></div>

<main class="orders-page">
    <div class="orders-container"
         th:with="
            safeSize=${pageData != null ? pageData.size : (size != null ? size : 10)},
            fromParam=${from != null ? #temporals.format(from, 'yyyy-MM-dd') : ''},
            toParam=${to != null ? #temporals.format(to, 'yyyy-MM-dd') : ''},
            qVal=${q != null ? q : ''},
            statusVal=${statusStr != null ? statusStr : ''},
            sortVal=${sort != null ? sort : 'createdAt'},
            dirVal=${dir != null ? dir : 'desc'}
         ">

        <div class="orders-card">
            <h1 class="orders-title">Lịch sử đơn hàng</h1>

            <div class="orders-top-links">
                <a class="o-btn o-btn-ghost" th:href="@{/customer/license-accounts}">
                    → License Accounts
                </a>
            </div>

            <p class="orders-sub">
                Xem các đơn hàng/transaction của bạn. Có thể tìm kiếm, lọc và sắp xếp theo nhiều tiêu chí.
            </p>

            <!-- FLASH -->
            <div th:if="${successMsg != null and !#strings.isEmpty(successMsg)}"
                 class="alert alert-success" th:text="${successMsg}"></div>
            <div th:if="${success != null and !#strings.isEmpty(success)}"
                 class="alert alert-success" th:text="${success}"></div>

            <div th:if="${errorMsg != null and !#strings.isEmpty(errorMsg)}"
                 class="alert alert-danger" th:text="${errorMsg}"></div>
            <div th:if="${error != null and !#strings.isEmpty(error)}"
                 class="alert alert-danger" th:text="${error}"></div>

            <!-- FILTER -->
            <form th:action="@{/customer/orders}" method="get" class="orders-row">
                <div class="orders-field">
                    <label class="orders-label">Tìm kiếm</label>
                    <input class="orders-input" type="text" name="q"
                           placeholder="Tool / License / OrderId / txnRef..." th:value="${qVal}">
                </div>

                <div class="orders-field">
                    <label class="orders-label">Trạng thái đơn</label>
                    <select class="orders-select" name="status">
                        <option value="" th:selected="${statusVal == ''}">Tất cả</option>
                        <option value="PENDING" th:selected="${statusVal == 'PENDING'}">PENDING</option>
                        <option value="SUCCESS" th:selected="${statusVal == 'SUCCESS'}">SUCCESS</option>
                        <option value="FAILED"  th:selected="${statusVal == 'FAILED'}">FAILED</option>
                    </select>
                </div>

                <!-- chỉ lọc NGÀY -->
                <div class="orders-field">
                    <label class="orders-label">Từ ngày</label>
                    <input class="orders-input" type="date" name="from" th:value="${fromParam}">
                </div>

                <div class="orders-field">
                    <label class="orders-label">Đến ngày</label>
                    <input class="orders-input" type="date" name="to" th:value="${toParam}">
                </div>

                <div class="orders-field">
                    <label class="orders-label">Sắp xếp theo</label>
                    <select class="orders-select" name="sort">
                        <option value="createdAt" th:selected="${sortVal == 'createdAt'}">Ngày tạo</option>
                        <option value="price" th:selected="${sortVal == 'price'}">Giá</option>
                        <option value="toolName" th:selected="${sortVal == 'toolName'}">Tên Tool</option>
                        <option value="licenseName" th:selected="${sortVal == 'licenseName'}">Tên License</option>
                        <option value="orderId" th:selected="${sortVal == 'orderId'}">Order ID</option>
                        <option value="orderStatus" th:selected="${sortVal == 'orderStatus'}">Trạng thái đơn</option>
                    </select>
                </div>

                <div class="orders-field">
                    <label class="orders-label">Chiều</label>
                    <select class="orders-select" name="dir">
                        <option value="desc" th:selected="${dirVal == 'desc'}">Giảm dần</option>
                        <option value="asc"  th:selected="${dirVal == 'asc'}">Tăng dần</option>
                    </select>
                </div>

                <div class="orders-field">
                    <label class="orders-label">Kích thước trang</label>
                    <select class="orders-select" name="size">
                        <option value="5"  th:selected="${safeSize == 5}">5</option>
                        <option value="10" th:selected="${safeSize == 10}">10</option>
                        <option value="20" th:selected="${safeSize == 20}">20</option>
                    </select>
                </div>

                <div class="orders-field">
                    <label class="orders-label">&nbsp;</label>
                    <button class="o-btn o-btn-primary" type="submit">Lọc</button>
                </div>

                <div class="orders-field">
                    <label class="orders-label">&nbsp;</label>
                    <a class="o-btn o-btn-ghost"
                       th:href="@{/customer/orders(page=0,size=${safeSize},q='',status='',from='',to='',sort='createdAt',dir='desc')}">
                        Reset
                    </a>
                </div>
            </form>

            <!-- EMPTY -->
            <div th:if="${pageData == null or pageData.totalElements == 0}" class="orders-empty">
                <b>Chưa có đơn hàng nào.</b>
                <div class="orders-muted">Khi bạn mua license/tool, đơn hàng sẽ xuất hiện ở đây.</div>
            </div>

            <!-- TABLE -->
            <div th:if="${pageData != null and pageData.totalElements > 0}">
                <table class="orders-table">
                    <thead>
                    <tr th:with="baseSize=${safeSize}">
                        <th class="orders-th">
                            <a class="orders-sortlink"
                               th:href="@{/customer/orders(page=0,size=${baseSize},q=${qVal},status=${statusVal},from=${fromParam},to=${toParam},sort='orderId',dir=${sortVal=='orderId' ? (dirVal=='asc'?'desc':'asc') : 'asc'})}">
                                #Order
                                <span class="orders-arrow"
                                      th:text="${sortVal=='orderId' ? (dirVal=='asc'?'↑':'↓') : '↕'}">↕</span>
                            </a>
                        </th>

                        <th class="orders-th">
                            <a class="orders-sortlink"
                               th:href="@{/customer/orders(page=0,size=${baseSize},q=${qVal},status=${statusVal},from=${fromParam},to=${toParam},sort='toolName',dir=${sortVal=='toolName' ? (dirVal=='asc'?'desc':'asc') : 'asc'})}">
                                Tool
                                <span class="orders-arrow"
                                      th:text="${sortVal=='toolName' ? (dirVal=='asc'?'↑':'↓') : '↕'}">↕</span>
                            </a>
                        </th>

                        <th class="orders-th">
                            <a class="orders-sortlink"
                               th:href="@{/customer/orders(page=0,size=${baseSize},q=${qVal},status=${statusVal},from=${fromParam},to=${toParam},sort='licenseName',dir=${sortVal=='licenseName' ? (dirVal=='asc'?'desc':'asc') : 'asc'})}">
                                License
                                <span class="orders-arrow"
                                      th:text="${sortVal=='licenseName' ? (dirVal=='asc'?'↑':'↓') : '↕'}">↕</span>
                            </a>
                        </th>

                        <th class="orders-th">
                            <a class="orders-sortlink"
                               th:href="@{/customer/orders(page=0,size=${baseSize},q=${qVal},status=${statusVal},from=${fromParam},to=${toParam},sort='price',dir=${sortVal=='price' ? (dirVal=='asc'?'desc':'asc') : 'asc'})}">
                                Giá
                                <span class="orders-arrow"
                                      th:text="${sortVal=='price' ? (dirVal=='asc'?'↑':'↓') : '↕'}">↕</span>
                            </a>
                        </th>

                        <th class="orders-th">
                            <a class="orders-sortlink"
                               th:href="@{/customer/orders(page=0,size=${baseSize},q=${qVal},status=${statusVal},from=${fromParam},to=${toParam},sort='orderStatus',dir=${sortVal=='orderStatus' ? (dirVal=='asc'?'desc':'asc') : 'asc'})}">
                                Trạng thái
                                <span class="orders-arrow"
                                      th:text="${sortVal=='orderStatus' ? (dirVal=='asc'?'↑':'↓') : '↕'}">↕</span>
                            </a>
                        </th>

                        <th class="orders-th">
                            <a class="orders-sortlink"
                               th:href="@{/customer/orders(page=0,size=${baseSize},q=${qVal},status=${statusVal},from=${fromParam},to=${toParam},sort='createdAt',dir=${sortVal=='createdAt' ? (dirVal=='asc'?'desc':'asc') : 'asc'})}">
                                Ngày tạo
                                <span class="orders-arrow"
                                      th:text="${sortVal=='createdAt' ? (dirVal=='asc'?'↑':'↓') : '↕'}">↕</span>
                            </a>
                        </th>

                        <th class="orders-th">Hành động</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="o : ${pageData.content}"
                        th:with="
                            isSuccess=${o.orderStatus != null and o.orderStatus.toString() == 'SUCCESS'},

                            txStatus=${(o.transaction != null and o.transaction.status != null) ? o.transaction.status.toString() : ''},
                            txBusy=${txStatus == 'PENDING' or txStatus == 'PROCESSING'},

                            laId=${(o.licenseAccount != null) ? o.licenseAccount.licenseAccountId : null},
                            laUsed=${(o.licenseAccount != null and o.licenseAccount.used != null) ? o.licenseAccount.used : false},
                            laStatus=${(o.licenseAccount != null and o.licenseAccount.status != null) ? o.licenseAccount.status.toString() : ''},
                            laRevoked=${laStatus == 'REVOKED'},

                            canUse=${isSuccess and laId != null and !laUsed and !laRevoked}
                        ">

                        <td class="orders-td">
                            <div><b th:text="${o.orderId}">1</b></div>
                        </td>

                        <td class="orders-td">
                            <div th:text="${o.tool != null ? o.tool.toolName : '(N/A)'}">Tool name</div>
                            <div class="orders-muted" th:if="${o.tool != null and o.tool.loginMethod != null}">
                                Login: <span th:text="${o.tool.loginMethod}">TOKEN</span>
                            </div>
                        </td>

                        <td class="orders-td" th:text="${o.license != null ? o.license.name : '(N/A)'}">License</td>

                        <td class="orders-td">
                            <b th:text="${o.price != null ? (#numbers.formatDecimal(o.price, 0, 'COMMA', 0, 'POINT') + ' VND') : '(N/A)'}">0 VND</b>
                        </td>

                        <td class="orders-td">
                            <span class="o-badge o-b-success" th:if="${isSuccess}">SUCCESS</span>
                            <span class="o-badge o-b-pending"
                                  th:if="${!isSuccess and o.orderStatus != null and o.orderStatus.toString() == 'PENDING'}">PENDING</span>
                            <span class="o-badge o-b-failed"
                                  th:if="${!isSuccess and o.orderStatus != null and o.orderStatus.toString() == 'FAILED'}">FAILED</span>
                            <span class="o-badge o-b-null" th:if="${o.orderStatus == null}">N/A</span>

                            <div class="orders-muted" th:if="${txBusy}">
                                Đang xử lý thanh toán...
                            </div>
                        </td>

                        <td class="orders-td">
                            <div th:text="${o.createdAt != null ? #temporals.format(o.createdAt,'dd/MM/yyyy HH:mm') : '(N/A)'}">--</div>
                        </td>

                        <td class="orders-td actions-cell">
                            <div class="o-actions">

                                <!-- Xem chi tiết (SUCCESS) -->
                                <a class="o-action o-action-view"
                                   th:if="${isSuccess}"
                                   th:href="@{/customer/orders/{id}(id=${o.orderId})}"
                                   title="Xem chi tiết">
                                    <i class="fa-solid fa-eye"></i>
                                </a>

                                <!-- Feedback (SUCCESS) -->
                                <a class="o-action o-action-primary"
                                   th:if="${isSuccess and o.tool != null}"
                                   th:href="@{/customer/feedback/create(orderId=${o.orderId}, toolId=${o.tool.toolId})}"
                                   title="Feedback">
                                    <i class="fa-regular fa-star"></i> Feedback
                                </a>

                                <!-- Báo cáo (SUCCESS) -->
                                <a class="o-action o-action-danger"
                                   th:if="${isSuccess}"
                                   th:href="@{/support/create(orderId=${o.orderId})}"
                                   title="Báo cáo">
                                    <i class="fa-regular fa-flag"></i> Báo cáo
                                </a>


                                <!-- ✅ DÙNG DỊCH VỤ: POST -->
                                <form th:if="${canUse}"
                                      th:action="@{/customer/license-accounts/{id}/use(id=${laId})}"
                                      method="post"
                                      style="display:inline;"
                                      onsubmit="return confirm('Xác nhận dùng dịch vụ cho đơn hàng này?');">
                                    <input type="hidden" th:if="${_csrf != null}"
                                           th:name="${_csrf.parameterName}"
                                           th:value="${_csrf.token}" />
                                    <input type="hidden" name="orderId" th:value="${o.orderId}"/>
                                    <button type="submit" class="o-action o-action-success" title="Dùng dịch vụ">
                                        <i class="fa-solid fa-play"></i> Dùng
                                    </button>
                                </form>

                                <!-- Nếu đã dùng -->
                                <span class="o-action o-action-success disabled"
                                      th:if="${isSuccess and laId != null and laUsed}"
                                      title="Đã dùng">
                                    <i class="fa-solid fa-check"></i> Đã dùng
                                </span>

                                <!-- Nếu bị REVOKED -->
                                <span class="o-action o-action-danger disabled"
                                      th:if="${isSuccess and laId != null and laRevoked}"
                                      title="LicenseAccount đã bị thu hồi">
                                    <i class="fa-solid fa-ban"></i> REVOKED
                                </span>

                                <!-- Thanh toán lại nếu KHÔNG SUCCESS -->
                                <form th:if="${!isSuccess}"
                                      th:action="@{/customer/orders/{id}/repay(id=${o.orderId})}"
                                      method="post"
                                      style="display:inline;"
                                      onsubmit="return confirm('Xác nhận thanh toán lại đơn hàng này qua VNPay?');">
                                    <input type="hidden" th:if="${_csrf != null}"
                                           th:name="${_csrf.parameterName}"
                                           th:value="${_csrf.token}" />
                                    <button type="submit" class="o-action o-action-danger" title="Thanh toán lại">
                                        <i th:class="${txBusy} ? 'fa-solid fa-hourglass-half' : 'fa-solid fa-rotate-right'"></i>
                                        <span th:text="${txBusy} ? ' Thanh toán lại' : ' Thanh toán lại'">Thanh toán lại</span>
                                    </button>
                                </form>

                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>

                <!-- PAGER -->
                <div class="orders-pager"
                     th:if="${pageData != null and pageData.totalPages > 1}"
                     th:with="cur=${pageData.number}, total=${pageData.totalPages}, sizeVal=${pageData.size}">

                    <div class="orders-muted">
                        Tổng: <b th:text="${pageData.totalElements}">0</b> đơn ·
                        Trang <b th:text="${cur + 1}">1</b>/<b th:text="${total}">1</b>
                    </div>

                    <div class="orders-page-links">
                        <a class="o-pill"
                           th:classappend="${pageData.first} ? ' disabled' : ''"
                           th:href="@{/customer/orders(page=${cur > 0 ? cur - 1 : 0},size=${sizeVal},q=${qVal},status=${statusVal},from=${fromParam},to=${toParam},sort=${sortVal},dir=${dirVal})}">
                            ← Trước
                        </a>

                        <a th:each="i : ${#numbers.sequence(0, total - 1)}"
                           class="o-pill"
                           th:classappend="${i == cur} ? ' active' : ''"
                           th:text="${i + 1}"
                           th:href="@{/customer/orders(page=${i},size=${sizeVal},q=${qVal},status=${statusVal},from=${fromParam},to=${toParam},sort=${sortVal},dir=${dirVal})}">
                            1
                        </a>

                        <a class="o-pill"
                           th:classappend="${pageData.last} ? ' disabled' : ''"
                           th:href="@{/customer/orders(page=${cur + 1 < total ? cur + 1 : cur},size=${sizeVal},q=${qVal},status=${statusVal},from=${fromParam},to=${toParam},sort=${sortVal},dir=${dirVal})}">
                            Sau →
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
